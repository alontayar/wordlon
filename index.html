<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>וורדלון</title>
<style>
  :root{
    --bg:#0b0c0f; --panel:#0f1218; --fg:#e7ecf3; --muted:#9aa8b8;
    --tile:#111723; --tile-border:#1e2633; --miss:#2a3342; --near:#f7b633; --hit:#22c55e;
    --key:#1b2230; --key-fg:#e7ecf3; --ring:#2d384a;
  }
  @media (prefers-color-scheme: light){
    :root{ --bg:#ffffff; --panel:#f7f7f8; --fg:#0f172a; --muted:#64748b;
      --tile:#e9eef5; --tile-border:#cbd5e1; --miss:#cbd5e1; --near:#f59e0b; --hit:#22c55e; --key:#e5e7eb; --key-fg:#0f172a; --ring:#d1d5db; }
  }
  *{box-sizing:border-box}
  body{margin:0; background:var(--bg); color:var(--fg); font:16px/1.45 system-ui, -apple-system, "Segoe UI", Arial, sans-serif}
  header{position:sticky; top:0; z-index:10; background:var(--panel); border-bottom:1px solid var(--ring)}
  .bar{max-width:920px; margin:0 auto; padding:12px 14px; display:flex; gap:12px; align-items:center; justify-content:space-between}
  nav[role="tablist"]{display:flex; gap:8px; order:-1}
  .tab,.btn{border:1px solid var(--ring); background:transparent; color:var(--fg); padding:8px 12px; border-radius:12px; cursor:pointer}
  h1{font-size:18px; margin:0}
  main{max-width:920px; margin:0 auto; padding:20px 14px 40px}
  .section{display:none}
  .section[aria-hidden="false"]{display:block}
  .grid{display:grid; gap:8px; margin:22px auto; justify-content:center}
  .row{display:grid; grid-template-columns:repeat(var(--len),min(64px,13.2vw)); gap:8px}
  .tile{display:flex; align-items:center; justify-content:center; border:2px solid var(--tile-border); background:var(--tile);
        font-weight:700; font-size:min(42px,9.2vw); aspect-ratio:1; border-radius:10px}
  .tile.filled{border-color:#8091a7}
  .tile.hit{background:var(--hit); color:#fff; border-color:var(--hit)}
  .tile.near{background:var(--near); color:#fff; border-color:var(--near)}
  .tile.miss{background:var(--miss); color:#a8b3c2; border-color:var(--miss)}
  .kbd{display:grid; gap:10px; justify-content:center; margin:20px auto; width:100%}
  .kbd-row{display:flex; gap:8px; justify-content:center; flex-wrap:wrap}
  .key{padding:12px 10px; min-width:34px; border:1px solid var(--ring); border-radius:10px; background:var(--key); color:var(--key-fg); cursor:pointer; font-weight:600}
  .wide{min-width:72px}
  .toast{position:fixed; left:50%; transform:translateX(-50%); top:72px; background:#0f172a; color:#fff; padding:10px 14px; border-radius:10px; opacity:0; transition:opacity .2s; pointer-events:none; border:1px solid var(--ring)}
  .toast.show{opacity:1}
  .share{display:flex; gap:8px; justify-content:center; align-items:center; flex-wrap:wrap; margin-top:12px}
  footer{margin:24px 0 36px; text-align:center; color:var(--muted); font-size:12px}
  @keyframes pop { 0%{transform:scale(0.9)} 40%{transform:scale(1.1)} 100%{transform:scale(1)} }
  .tile.pop{animation:pop .12s ease}
</style>
</head>
<body>
<header>
  <div class="bar">
    <nav role="tablist" aria-label="מצבים">
      <button class="tab" id="tabDaily" role="tab" aria-selected="true" data-target="daily">וורדלון היומי</button>
      <button class="tab" id="tabCustom" role="tab" aria-selected="false" data-target="custom">התאמה אישית</button>
    </nav>
    <h1>וורדלון</h1>
    <div style="display:flex; gap:8px; align-items:center">
      <button id="btnStats" class="btn" title="סטטיסטיקות">📊</button>
      <button id="btnTheme" class="btn" title="מצב כהה">☾</button>
    </div>
  </div>
</header>

<main>
  <section id="daily" class="section" aria-hidden="false">
    <div id="dailyBoard" class="grid"></div>
    <div id="dailyKbd" class="kbd" aria-label="מקלדת וירטואלית"></div>
    <div class="share" id="dailyShare"></div>
    <div id="countdown" style="text-align:center; color:var(--muted); margin-top:6px"></div>
  </section>

  <section id="custom" class="section" aria-hidden="true">
    <div style="display:flex; gap:10px; align-items:center; justify-content:center; flex-wrap:wrap">
      <input id="secretInput" dir="rtl" inputmode="text" maxlength="10" placeholder="מילה (3–10)" style="padding:10px 12px; border-radius:10px; border:1px solid var(--ring); background:var(--panel); color:var(--fg)">
      <button id="makeLink" class="btn">קישור</button>
    </div>
    <div id="linkOut" class="share"></div>
    <hr style="margin:22px 0; opacity:0.2">
    <div id="customBoard" class="grid"></div>
    <div id="customKbd" class="kbd" aria-label="מקלדת וירטואלית"></div>
  </section>
</main>

<footer>
  <span>&copy; אלון תייר <span id="year">2025</span></span>
</footer>

<div class="toast" id="toast" role="status" aria-live="polite"></div>

<dialog id="dlgStats">
  <div style="padding:14px; border-bottom:1px solid var(--ring); display:flex; justify-content:space-between; align-items:center">
    <strong>סטטיסטיקות</strong>
    <button class="btn" id="dlgClose">✖</button>
  </div>
  <div style="padding:16px">
    <div style="display:flex; gap:16px; justify-content:space-around; text-align:center">
      <div><b id="stPlayed" style="display:block; font-size:32px">0</b>משחקים</div>
      <div><b id="stWin" style="display:block; font-size:32px">0</b>ניצחונות</div>
      <div><b id="stStreak" style="display:block; font-size:32px">0</b>רצף</div>
      <div><b id="stBest" style="display:block; font-size:32px">0</b>שיא רצף</div>
    </div>
  </div>
</dialog>

<script>
'use strict';
function ready(fn){ if (document.readyState!=='loading') fn(); else document.addEventListener('DOMContentLoaded', fn); }
ready(()=>{
  const E = id => document.getElementById(id);
  const el = {
    tabDaily:E('tabDaily'), tabCustom:E('tabCustom'),
    daily:E('daily'), custom:E('custom'),
    dailyBoard:E('dailyBoard'), dailyKbd:E('dailyKbd'),
    dailyShare:E('dailyShare'), countdown:E('countdown'),
    secretInput:E('secretInput'), makeLink:E('makeLink'), linkOut:E('linkOut'),
    customBoard:E('customBoard'), customKbd:E('customKbd'),
    btnStats:E('btnStats'), btnTheme:E('btnTheme'),
    dlgStats:E('dlgStats'), dlgClose:E('dlgClose'),
    stPlayed:E('stPlayed'), stWin:E('stWin'), stStreak:E('stStreak'), stBest:E('stBest'),
  };

  // Tiny debug banner (remove if you want)
  const dbg = document.createElement('div');
  dbg.style.cssText="position:fixed;bottom:6px;left:6px;background:#0008;color:#fff;padding:4px 8px;border-radius:8px;font-size:12px";
  dbg.textContent="JS: OK"; document.body.appendChild(dbg);

  // Theme toggle
  (function(){ const saved = localStorage.getItem('theme'); if (saved==='light') document.documentElement.setAttribute('data-theme','light'); })();
  el.btnTheme.addEventListener('click', ()=>{
    const root=document.documentElement; const isLight=root.getAttribute('data-theme')==='light';
    root.setAttribute('data-theme', isLight ? '' : 'light'); localStorage.setItem('theme', isLight ? '' : 'light');
  });

  const tz='Asia/Jerusalem';
  const finalsMap={'ך':'כ','ם':'מ','ן':'נ','ף':'פ','ץ':'צ'};
  const normalizeHeb = s=>s.replace(/\s+/g,'').replace(/[״"]/g,'').trim();
  const lettersEqual = (a,b)=> (finalsMap[a]||a) === (finalsMap[b]||b);
  const baseURL = location.origin + location.pathname.replace(/index\.html?$/,'');

  function toLocalDateStr(date=new Date()){
    const parts = new Intl.DateTimeFormat('he-IL',{timeZone:tz,year:'numeric',month:'2-digit',day:'2-digit'}).formatToParts(date);
    const y = parts.find(p=>p.type==='year').value.padStart(4,'0');
    const m = parts.find(p=>p.type==='month').value.padStart(2,'0');
    const d = parts.find(p=>p.type==='day').value.padStart(2,'0');
    return `${y}-${m}-${d}`;
  }
  function toast(msg){ const t=E('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 1400); }

  // Embedded dictionary (no fetch)
  const WORDS = [
    "שלום","חלון","ספרי","מפתח","תמונה","גבינה","בדיקה","בריכה","גשמים","ארמון",
    "אולפן","אפרסק","חולצה","חופשה","חמסין","טייסת","חיבוק","כורסה","כתמים","כתיבה",
    "ויכוח","זחילה","זריחה","זרימה","חולון","חורשה","חללית","ידידה","יהלום","יצירה",
    "ירקות","כיסוי","כותרת","כינוי","כספים","כינוס","כרישה","כריתה","כרכור","כתובת"
  ];

  function isValidWord(w){ return /^[א-תךםןףץ]+$/.test(w) && WORDS.includes(w); }

  const statsKey='wordlon.stats';
  function loadStats(){ try{ return JSON.parse(localStorage.getItem(statsKey)) || {played:0,wins:0,streak:0,best:0,lastDate:''}; } catch(e){ return {played:0,wins:0,streak:0,best:0,lastDate:''}; } }
  function saveStats(s){ localStorage.setItem(statsKey, JSON.stringify(s)); }
  function updateStatsUI(){ const s=loadStats(); el.stPlayed.textContent=s.played; el.stWin.textContent=s.wins; el.stStreak.textContent=s.streak; el.stBest.textContent=s.best; }
  el.btnStats.addEventListener('click', ()=>{ updateStatsUI(); el.dlgStats.showModal(); });
  el.dlgClose.addEventListener('click', ()=>el.dlgStats.close());

  function dailyCandidates(){ return WORDS.filter(w=>/^[א-תךםןףץ]{5}$/.test(w)); }
  function seededIndex(dateStr,len){ let h=0; for (let i=0;i<dateStr.length;i++){ h=((h<<5)-h)+dateStr.charCodeAt(i); h|=0; } return Math.abs(h)%len; }
  function getDailyAnswer(dateStr){ const A=dailyCandidates(); return A.length? A[seededIndex(dateStr,A.length)] : (A[0]||'שלום'); }

  const rowsCount = 6;
  const hebRows = [['ק','ר','א','ט','ו','ן','ם','פ'],['ש','ד','ג','כ','ע','י','ח','ל','ך','ף'],['ז','ס','ב','ה','נ','מ','צ','ת','ץ']];

  function buildBoard(container,len=5,rows=rowsCount){
    container.style.setProperty('--len', len);
    container.innerHTML='';
    for (let r=0;r<rows;r++){
      const row=document.createElement('div'); row.className='row';
      for (let c=0;c<len;c++){
        const t=document.createElement('div'); t.className='tile'; t.dataset.row=r; t.dataset.col=c;
        row.appendChild(t);
      }
      container.appendChild(row);
    }
  }
  function buildKeyboard(container,onKey){
    container.innerHTML='';
    hebRows.forEach((row,ri)=>{
      const R=document.createElement('div'); R.className='kbd-row';
      row.forEach(ch=>{ const b=document.createElement('button'); b.className='key'; b.textContent=ch; b.onclick=()=>onKey(ch); R.appendChild(b); });
      if (ri===2){
        const enter=document.createElement('button'); enter.className='key wide'; enter.textContent='שליחה'; enter.onclick=()=>onKey('ENTER'); R.prepend(enter);
        const bk=document.createElement('button'); bk.className='key wide'; bk.textContent='⌫'; bk.onclick=()=>onKey('BACK'); R.appendChild(bk);
      }
      container.appendChild(R);
    });
  }
  function scoreGuess(guess,answer){
    const n=answer.length, res=Array(n).fill('miss'), ans=answer.split(''), g=guess.split('');
    for (let i=0;i<n;i++){ if (lettersEqual(g[i],ans[i])){ res[i]='hit'; ans[i]=null; g[i]=null; } }
    for (let i=0;i<n;i++){ if (g[i]==null) continue; const idx=ans.findIndex(ch=>ch && lettersEqual(ch,g[i])); if (idx>-1){ res[i]='near'; ans[idx]=null; } }
    return res;
  }

  function Game({boardEl,kbdEl,answer,mode='daily',shareEl,onWinLose}){
    const len=answer.length; let curRow=0, curCol=0, done=false;
    buildBoard(boardEl,len); buildKeyboard(kbdEl, handleKey);
    const tiles=Array.from({length:rowsCount},()=>Array(len).fill('')); const keyStates={};
    const tileAt=(r,c)=>boardEl.children[r].children[c];
    function updateTiles(popIndex=null){
      for (let c=0;c<len;c++){
        const t=tileAt(curRow,c); t.textContent=tiles[curRow][c]||'';
        t.classList.toggle('filled', !!tiles[curRow][c]);
        if (popIndex===c){ t.classList.remove('pop'); void t.offsetWidth; t.classList.add('pop'); }
      }
    }
    function paintKeys(){
      for (const [ch,state] of Object.entries(keyStates)){
        [...kbdEl.querySelectorAll('.key')].filter(b=>b.textContent===ch).forEach(b=>b.dataset.state=state);
      }
    }
    function revealRow(marks){
      const rEl = boardEl.children[curRow];
      [...rEl.children].forEach((t,i)=>{ t.classList.remove('hit','near','miss'); t.classList.add(marks[i]); });
    }
    function commitGuess(){
      const guess = tiles[curRow].join('');
      if (guess.length!==len){ toast('לא מספיק אותיות'); return; }
      if (!/^[א-תךםןףץ]+$/.test(guess)){ toast('רק עברית'); return; }
      if (mode==='daily' && !isValidWord(guess)){ toast('מילה לא מוכרת'); return; }
      const marks=scoreGuess(guess,answer);
      revealRow(marks);
      guess.split('').forEach((ch,i)=>{
        const m=marks[i]; const prev=keyStates[ch]; const rank={miss:0,near:1,hit:2};
        if (!prev || rank[m]>rank[prev]) keyStates[ch]=m;
      });
      paintKeys();
      const win = marks.every(m=>'hit'===m);
      curRow++; curCol=0;
      if (win){ done=true; onWinLose && onWinLose(true,curRow); return; }
      if (curRow>=rowsCount){ toast('המילה הייתה: '+answer); done=true; onWinLose && onWinLose(false,curRow); return; }
    }
    function handleKey(k){
      if (done) return;
      if (k==='ENTER') return commitGuess();
      if (k==='BACK'){ if (curCol>0){ curCol--; tiles[curRow][curCol]=''; updateTiles(); } return; }
      if (k.length===1){
        if (curCol>=len) return;
        if (!/[א-תךםןףץ]/.test(k)) return;
        tiles[curRow][curCol]=k; updateTiles(curCol); curCol++;
      }
    }
    window.addEventListener('keydown', ev=>{
      const k=ev.key;
      if (k==='Enter') return handleKey('ENTER');
      if (k==='Backspace') return handleKey('BACK');
      if (/^[א-ת]$/.test(k)) return handleKey(k);
    });
    return {handleKey};
  }

  let currentDateStr, dailyAnswer, dailyGame;
  function initDaily(){
    currentDateStr = toLocalDateStr();
    dailyAnswer = getDailyAnswer(currentDateStr);
    dailyGame = Game({boardEl: el.dailyBoard, kbdEl: el.dailyKbd, answer:dailyAnswer, mode:'daily', shareEl:el.dailyShare, onWinLose:onDailyEnd});
    updateCountdown();
  }
  function onDailyEnd(win){
    const s=loadStats();
    if (s.lastDate!==currentDateStr){
      s.played+=1; s.lastDate=currentDateStr;
      if (win){ s.wins+=1; s.streak+=1; s.best=Math.max(s.best,s.streak); } else { s.streak=0; }
      saveStats(s);
    }
    updateStatsUI();
  }
  function updateCountdown(){
    const now=new Date(); const nowStr=toLocalDateStr(now);
    if (nowStr!==currentDateStr){ initDaily(); return; }
    const midnight=new Date(); midnight.setHours(24,0,0,0);
    const diff=midnight-now;
    const h=String(Math.floor(diff/3_600_000)).padStart(2,'0');
    const m=String(Math.floor((diff%3_600_000)/60_000)).padStart(2,'0');
    const s=String(Math.floor((diff%60_000)/1000)).padStart(2,'0');
    el.countdown.textContent=`${h}:${m}:${s}`;
  }
  setInterval(updateCountdown, 1000);

  function selectTab(id){
    [el.tabDaily, el.tabCustom].forEach(t=>{ const on=t.dataset.target===id; t.setAttribute('aria-selected', on?'true':'false'); });
    [el.daily, el.custom].forEach(s=>{ s.setAttribute('aria-hidden', s.id===id ? 'false':'true'); });
  }
  el.tabDaily.addEventListener('click', ()=>selectTab('daily'));
  el.tabCustom.addEventListener('click', ()=>selectTab('custom'));

  el.makeLink.addEventListener('click', ()=>{
    const raw=normalizeHeb(el.secretInput.value);
    if (raw.length<3 || raw.length>10){ toast('3–10'); return; }
    if (!/^[א-תךםןףץ]+$/.test(raw)){ toast('עברית'); return; }
    const url=`${baseURL}#custom=${encodeURIComponent(raw)}`;
    el.linkOut.innerHTML='';
    const a=document.createElement('a'); a.href=url; a.textContent='פתח'; a.className='btn';
    const b=document.createElement('button'); b.textContent='העתק'; b.className='btn'; b.onclick=async()=>{ try{ await navigator.clipboard.writeText(url); toast('הועתק'); }catch(e){} };
    el.linkOut.append(a,b);
  });
  function maybeLoadCustomFromHash(){
    const m=location.hash.match(/#custom=([^&]+)/);
    if (!m) return;
    const secret=decodeURIComponent(m[1]);
    if (!/^[א-תךםןףץ]{3,10}$/.test(secret)) return;
    selectTab('custom'); startCustomGame(secret);
  }
  function startCustomGame(secret){
    el.customBoard.innerHTML=''; el.customKbd.innerHTML=''; el.linkOut.innerHTML='';
    Game({boardEl: el.customBoard, kbdEl: el.customKbd, answer:secret, mode:'custom', shareEl:el.linkOut});
  }
  window.addEventListener('hashchange', maybeLoadCustomFromHash);

  document.getElementById('year').textContent = new Date().getFullYear();
  function init(){ initDaily(); maybeLoadCustomFromHash(); }
  init();
});
</script>
</body>
</html>
