<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>וורדלון</title>
<style>
@font-face{font-family:'Normal093';src:url('./Normal0.93-Regular.woff') format('woff');font-weight:400;font-style:normal;font-display:swap}
@font-face{font-family:'Normal093';src:url('./Normal0.93-Medium.woff') format('woff');font-weight:500;font-style:normal;font-display:swap}
@font-face{font-family:'Normal093';src:url('./Normal0.93-Bold.woff') format('woff');font-weight:700;font-style:normal;font-display:swap}

/* --- Dark theme only --- */
:root{
  --bg:#0b0c0f; --panel:#0f1218; --fg:#e7ecf3; --muted:#9aa8b8;
  --tile:#111723; --tile-border:#1e2633;
  --miss:#2f2f2f;            /* אפור נייטרלי כהה */
  --near:#facc15;            /* צהוב */
  --hit:#22c55e;             /* ירוק */
  --key:#1b2230; --ring:#2d384a;
}

*{box-sizing:border-box}
body{margin:0; background:var(--bg); color:var(--fg); font:16px/1.45 "Normal093",system-ui,-apple-system,"Segoe UI",Arial,sans-serif}
button,input,select,textarea{font-family:inherit}
header{position:sticky; top:0; z-index:10; background:var(--panel); border-bottom:1px solid var(--ring)}
.bar{max-width:920px; margin:0 auto; padding:12px 14px; display:flex; gap:12px; align-items:center; justify-content:space-between}
h1{font-size:22px; margin:0}
h1 a{color:inherit; text-decoration:none}

main{max-width:920px; margin:0 auto; padding:20px 14px 40px}

.btn{border:1px solid var(--ring); background:transparent; color:#000; padding:8px 12px; border-radius:12px; cursor:pointer}
.btn:disabled{opacity:.6; cursor:not-allowed}

/* לוח */
.grid{display:grid; gap:8px; margin:22px auto; justify-content:center}
.row{display:grid; grid-template-columns:repeat(var(--len),min(64px,13.2vw)); gap:8px}
.tile{
  display:flex; align-items:center; justify-content:center;
  border:2px solid var(--tile-border); background:var(--tile);
  font-weight:500; font-size:min(42px,9.2vw); aspect-ratio:1; border-radius:10px;
  color:#fff;                          /* תמיד לבן */
}
.tile.filled{border-color:#3b4a5f}
.tile.hit{background:var(--hit); color:#fff; border-color:var(--hit)}
.tile.near{background:var(--near); color:#fff; border-color:var(--near)}
.tile.miss{background:var(--miss); color:#fff; border-color:var(--miss)}

/* מקלדת */
.kbd{display:grid; gap:10px; justify-content:center; margin:20px auto; width:100%}
.kbd-row{display:flex; gap:8px; justify-content:center; flex-wrap:wrap}
.key{
  padding:14px 12px; min-width:40px; border:1px solid var(--ring); border-radius:10px;
  background:var(--key); color:#fff; cursor:pointer; font-weight:500; font-size:16px
}
.wide{min-width:80px}
.key[data-state="miss"]{ background:var(--miss); color:#fff; }
.key[data-state="near"]{ background:var(--near); color:#fff; }
.key[data-state="hit"]{ background:var(--hit); color:#fff; }

.toast{position:fixed; left:50%; transform:translateX(-50%); top:72px; background:#0f172a; color:#fff; padding:10px 14px; border-radius:10px; opacity:0; transition:opacity .2s; pointer-events:none; border:1px solid var(--ring)}
.toast.show{opacity:1}

footer{margin:24px 0 36px; text-align:center; color:var(--muted); font-size:12px}

/* סטטיסטיקה (דיאלוג) */
dialog{border:none; border-radius:14px; background:var(--panel); color:var(--fg); width:min(560px,92vw); padding:0}
.stat-h{padding:14px; border-bottom:1px solid var(--ring); display:flex; justify-content:space-between; align-items:center}
.stat-body{padding:16px}
.stats-grid{display:flex; gap:16px; justify-content:space-around; text-align:center; flex-wrap:wrap}
.stats-grid div b{display:block; font-size:32px}
.progress{margin-top:16px}
.progress .row{grid-template-columns: 36px 1fr 42px}
.progress .lbl{opacity:.9}
.progress .bar{height:18px; background:#222; border-radius:8px; overflow:hidden}
.progress .fill{height:100%; background:#3b82f6}
.actions{display:flex; gap:8px; justify-content:flex-end; padding:12px 16px; border-top:1px solid var(--ring)}
/* כפתור סטטיסטיקה: שחור ומידות כמו הירח שהיה */
#btnStats{width:36px; height:36px; border-radius:12px; display:grid; place-items:center; padding:0; color:#000; background:#fff}
#btnStats svg{width:18px; height:18px; fill:#000}
</style>
</head>
<body>
<header>
  <div class="bar">
    <h1><a href="./">וורדלון</a></h1>
    <div style="display:flex; gap:8px; align-items:center">
      <!-- כפתור סטטיסטיקה (מונו, שחור) -->
      <button id="btnStats" class="btn" title="סטטיסטיקות" aria-haspopup="dialog" aria-controls="dlgStats" aria-expanded="false">
        <!-- איקון עמודות שחור -->
        <svg viewBox="0 0 24 24" aria-hidden="true"><path d="M4 20h3V10H4v10zm6 0h3V4h-3v16zm6 0h3v-7h-3v7z"/></svg>
      </button>
    </div>
  </div>
</header>

<!-- רשימות מילים נטענות לפני הסקריפט -->
<script src="./allowedwords.js"></script>
<script src="./wordlons.js"></script>

<main>
  <section id="daily" class="section" aria-hidden="false">
    <div id="dailyBoard" class="grid"></div>
    <div id="dailyKbd" class="kbd" aria-label="מקלדת וירטואלית"></div>
    <div class="actions">
      <button id="btnShare" class="btn">שתף</button>
    </div>
  </section>
</main>

<footer>
  <span>&copy; אלון תייר <span id="year">2025</span></span>
</footer>

<div class="toast" id="toast" role="status" aria-live="polite"></div>

<!-- דיאלוג סטטיסטיקות -->
<dialog id="dlgStats">
  <div class="stat-h">
    <strong>סטטיסטיקות</strong>
    <button class="btn" id="dlgClose">✖</button>
  </div>
  <div class="stat-body">
    <div class="stats-grid">
      <div><b id="stPlayed">0</b>משחקים</div>
      <div><b id="stWinP">0</b>% ניצחון</div>
      <div><b id="stStreak">0</b>רצף נוכחי</div>
      <div><b id="stBest">0</b>שיא רצף</div>
    </div>
    <h3 style="margin:18px 0 8px">התפלגות ניחושים</h3>
    <div id="guessDist" class="progress"></div>
  </div>
</dialog>

<script>
'use strict';
const E = id => document.getElementById(id);

/* ===== Utils & Config ===== */
const finals = {'ך':'כ','ם':'מ','ן':'נ','ף':'פ','ץ':'צ'};
const norm = s => (s||'').normalize('NFC').replace(/\s+/g,'').replace(/[״"]/g,'').replace(/[ךםןףץ]/g, ch => finals[ch]).trim();
const isHeb = s => /^[א-תךםןףץ]+$/.test(s);
const rowsCount=6;
const epoch = new Date('2025-01-01T00:00:00+02:00'); // ספירה ל"מס׳ יומי"

/* Word lists (תמיכה בשמות משתנים) */
const allowedRaw = (typeof allowedWords !== 'undefined' ? allowedWords :
                    (typeof hebWords !== 'undefined' ? hebWords : ''));
const answersRaw = (typeof wordlons !== 'undefined' ? wordlons :
                    (typeof listOfWords !== 'undefined' ? listOfWords : []));
let ALLOWED = new Set();
if (Array.isArray(allowedRaw)){ ALLOWED = new Set(allowedRaw.map(norm)); }
else if (typeof allowedRaw === 'string'){ ALLOWED = new Set(allowedRaw.split(/[\s,]+/).filter(Boolean).map(norm)); }

const ANSWERS5 = (Array.isArray(answersRaw)?answersRaw:[])
  .map(s => (''+s).trim()).filter(s => /^[א-תךםןףץ]{5}$/.test(s));
if (!ANSWERS5.length) ANSWERS5.push('שלום');
if (!ALLOWED.size) ['שלום','חלום','חלון','עולם','בדיקה','אולפן','תמונה'].forEach(w=>ALLOWED.add(norm(w)));

function todayKey(){
  const now=new Date(); const y=now.getFullYear(); const m=String(now.getMonth()+1).padStart(2,'0'); const d=String(now.getDate()).padStart(2,'0');
  return `${y}-${m}-${d}`;
}
function dailyIndex(){
  const now = new Date();
  return Math.floor((now - epoch)/86400000); // 0,1,2...
}
function dailyNumberString(){ return (dailyIndex()+1).toLocaleString('he-IL'); }
function getDailyAnswer(){ return ANSWERS5[dailyIndex()%ANSWERS5.length]; }

/* ===== Storage Keys ===== */
const K_STATS = 'wordlon.stats.v1';
const K_STATE = 'wordlon.state.v1';   // שמירת משחק היום (אמצע/סיום)

/* ===== Stats ===== */
function loadStats(){
  try{
    const s = JSON.parse(localStorage.getItem(K_STATS)||'null');
    return s || {played:0,wins:0,streak:0,best:0,lastDate:'',lastWin:false,dist:{1:0,2:0,3:0,4:0,5:0,6:0}};
  }catch(e){ return {played:0,wins:0,streak:0,best:0,lastDate:'',lastWin:false,dist:{1:0,2:0,3:0,4:0,5:0,6:0}}; }
}
function saveStats(s){ localStorage.setItem(K_STATS, JSON.stringify(s)); }
function ymd(d){ return d.toISOString().slice(0,10); }
function isYesterday(prev){
  const p=new Date(prev+'T00:00:00'); const n=new Date(); const y=new Date(n.getFullYear(), n.getMonth(), n.getDate()-1);
  return ymd(p)===ymd(y);
}
function commitStats(win, tries){
  const s=loadStats(); const td=todayKey();
  if (s.lastDate!==td){ s.played += 1; }
  if (win){ s.wins += (s.lastDate===td && s.lastWin) ? 0 : 1; }
  // streak
  if (s.lastDate===td){ /* אותו יום – אל תשנה streak */ }
  else if (isYesterday(s.lastDate)){ s.streak = win ? s.streak+1 : 0; }
  else { s.streak = win ? 1 : 0; }
  s.best = Math.max(s.best, s.streak);
  if (win && tries>=1 && tries<=6){ s.dist[tries] = (s.dist[tries]||0)+1; }
  s.lastDate = td; s.lastWin = !!win;
  saveStats(s);
}
function renderStats(){
  const s=loadStats();
  const winp = s.played ? Math.round((s.wins/s.played)*100) : 0;
  E('stPlayed').textContent = s.played;
  E('stWinP').textContent = winp;
  E('stStreak').textContent = s.streak;
  E('stBest').textContent = s.best;
  const gd = E('guessDist'); gd.innerHTML='';
  const max = Math.max(1, ...Object.values(s.dist));
  for(let i=1;i<=6;i++){
    const n = s.dist[i]||0;
    const row = document.createElement('div'); row.className='row'; row.style='grid-template-columns:36px 1fr 42px; align-items:center; gap:8px; margin:6px 0';
    const lbl = document.createElement('div'); lbl.className='lbl'; lbl.textContent=i;
    const bar = document.createElement('div'); bar.className='bar';
    const fill = document.createElement('div'); fill.className='fill'; fill.style.width = (n? Math.max(12,(n/max)*100) : 0)+'%';
    bar.appendChild(fill);
    const cnt = document.createElement('div'); cnt.textContent=n;
    row.appendChild(lbl); row.appendChild(bar); row.appendChild(cnt);
    gd.appendChild(row);
  }
}

/* ===== Game ===== */
const hebRows = [
  ['פ','ו','ט','א','ר','ק'],
  ['ל','ח','י','ע','כ','ג','ד','ש'],
  ['ת','צ','מ','נ','ה','ב','ס','ז']
];
const lettersEqual=(a,b)=> (finals[a]||a)===(finals[b]||b);
function scoreGuess(guess,answer){
  const n=answer.length, res=Array(n).fill('miss'), ans=answer.split(''), g=guess.split('');
  for (let i=0;i<n;i++){ if (lettersEqual(g[i],ans[i])){ res[i]='hit'; ans[i]=null; g[i]=null; } }
  for (let i=0;i<n;i++){ if (g[i]==null) continue; const idx=ans.findIndex(ch=>ch && lettersEqual(ch,g[i])); if (idx>-1){ res[i]='near'; ans[idx]=null; } }
  return res;
}
function buildBoard(container,len=5,rows=rowsCount){
  container.style.setProperty('--len', len);
  container.innerHTML='';
  for (let r=0;r<rows;r++){
    const row=document.createElement('div'); row.className='row';
    for (let c=0;c<len;c++){
      const t=document.createElement('div'); t.className='tile'; t.dataset.row=r; t.dataset.col=c;
      row.appendChild(t);
    }
    container.appendChild(row);
  }
}
function buildKeyboard(container,onKey){
  container.innerHTML='';
  hebRows.forEach((row,ri)=>{
    const R=document.createElement('div'); R.className='kbd-row';
    if (ri===2){
      const enter=document.createElement('button'); enter.className='key wide'; enter.textContent='שליחה'; enter.onclick=()=>onKey('ENTER'); R.appendChild(enter);
    }
    row.forEach(ch=>{ const b=document.createElement('button'); b.className='key'; b.textContent=ch; b.onclick=()=>onKey(ch); R.appendChild(b); });
    if (ri===2){
      const bk=document.createElement('button'); bk.className='key wide'; bk.textContent='⌫'; bk.onclick=()=>onKey('BACK'); R.appendChild(bk);
    }
    container.appendChild(R);
  });
}

function toast(msg){ const t=E('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 1200); }

/* שמירת מצב משחק (אמצע) */
function loadState(){
  try{ return JSON.parse(localStorage.getItem(K_STATE)||'null')||{}; }catch(e){ return {}; }
}
function saveState(state){ localStorage.setItem(K_STATE, JSON.stringify(state)); }
function clearState(){ localStorage.removeItem(K_STATE); }

function Game({boardEl,kbdEl,answer,onEnd}){
  const len=answer.length; let curRow=0, curCol=0, done=false;
  buildBoard(boardEl,len); buildKeyboard(kbdEl, handleKey);
  const tiles=Array.from({length:rowsCount},()=>Array(len).fill(''));
  const keyStates={};

  // נסה לשחזר מצב קודם של היום
  (function restore(){
    const s=loadState();
    if (!s || s.date!==todayKey()) return;
    // שחזור ניחושים שהוגשו
    (s.guesses||[]).forEach(g=>{
      if (g.length!==len) return;
      tiles[curRow]=g.split('');
      revealCommit();
    });
    // שחזור שורה נוכחית חלקית
    if (s.partial){
      [...s.partial].slice(0,len).forEach(ch=>{
        if (/^[א-תךםןףץ]$/.test(ch) && curCol<len){ tiles[curRow][curCol]=ch; updateTiles(curRow,curCol++); }
      });
      persist();
    }
  })();

  function tileAt(r,c){ return boardEl.children[r].children[c]; }
  function updateTiles(r,cPop=null){
    for (let c=0;c<len;c++){
      const t=tileAt(r,c); t.textContent=tiles[r][c]||'';
      t.classList.toggle('filled', !!tiles[r][c]);
      if (cPop===c){ t.classList.remove('pop'); void t.offsetWidth; t.classList.add('pop'); }
    }
  }
  function paintKeys(){
    for (const [ch,state] of Object.entries(keyStates)){
      [...kbdEl.querySelectorAll('.key')].filter(b=>b.textContent===ch).forEach(b=>b.dataset.state=state);
    }
  }
  function revealRow(marks){
    const rEl = boardEl.children[curRow];
    [...rEl.children].forEach((t,i)=>{ t.classList.remove('hit','near','miss'); t.classList.add(marks[i]); });
  }
  function persist(){
    const guesses = [];
    for (let r=0;r<curRow;r++){ guesses.push(tiles[r].join('')); }
    const partial = tiles[curRow].slice(0,curCol).join('');
    saveState({date: todayKey(), guesses, partial});
  }
  function revealCommit(){
    const guess = tiles[curRow].join('');
    const marks=scoreGuess(guess,answer);
    revealRow(marks);
    guess.split('').forEach((ch,i)=>{
      const m=marks[i];
      const base = finals[ch] || ch;
      const prev=keyStates[base]; const rank={miss:0,near:1,hit:2};
      if (!prev || rank[m]>rank[prev]) keyStates[base]=m;
    });
    paintKeys();
    curRow++; curCol=0;
  }

  function commitGuess(){
    const guess = tiles[curRow].join('');
    if (guess.length!==len){ rowShake(); toast('לא מספיק אותיות'); return; }
    if (!isHeb(guess)){ rowShake(); toast('רק עברית'); return; }
    if (!ALLOWED.has(norm(guess))){ rowShake(); toast('מילה לא מוכרת'); return; }

    revealCommit();
    persist();

    const win = guess===answer;
    if (win){
      done=true; clearState();
      commitStats(true, curRow); onEnd && onEnd(true, curRow);
      toast('כל הכבוד!');
      return;
    }
    if (curRow>=rowsCount){
      done=true; clearState();
      commitStats(false, rowsCount); onEnd && onEnd(false, rowsCount);
      toast('המילה הייתה: '+answer);
      return;
    }
  }
  function rowShake(){ const row=boardEl.children[curRow]; row.classList.remove('shake'); void row.offsetWidth; row.classList.add('shake'); }

  function handleKey(k){
    if (done) return;
    if (k==='ENTER') return commitGuess();
    if (k==='BACK'){
      if (curCol>0){ curCol--; tiles[curRow][curCol]=''; updateTiles(curRow); persist(); }
      return;
    }
    if (k.length===1){
      if (curCol>=len) return;
      if (!/^[א-תךםןףץ]$/.test(k)) return;
      tiles[curRow][curCol]=k; updateTiles(curRow,curCol); curCol++; persist();
    }
  }

  window.addEventListener('keydown', ev=>{
    const k=ev.key;
    if (k==='Enter') return handleKey('ENTER');
    if (k==='Backspace') return handleKey('BACK');
    if (/^[א-ת]$/.test(k)) return handleKey(k);
  });

  return {handleKey};
}

/* ===== Share ===== */
function marksToEmoji(marks){
  return marks.map(m=> m==='hit'?'🟩' : m==='near'?'🟨' : '⬛').join('');
}
function buildShareText(history, answer, triesOrX){
  // history: array of {guess, marks[]}
  const header = `וורדלון ${dailyNumberString()} ${triesOrX}/6`;
  const grid = history.map(h=>marksToEmoji(h.marks)).join('\n');
  return `${header}\n\n${grid}`;
}

/* ===== Boot ===== */
(function init(){
  // שנה בכותרת
  E('year').textContent = new Date().getFullYear();

  const board=E('dailyBoard'), kbd=E('dailyKbd');
  const answer = getDailyAnswer();
  const game = Game({boardEl:board, kbdEl:kbd, answer, onEnd:(win,tries)=>{/* סטט׳ כבר נרשמה בקומיט */}});

  // סטטיסטיקה דיאלוג
  const dlg=E('dlgStats'); const btnOpen=E('btnStats'); const btnClose=E('dlgClose');
  btnOpen.addEventListener('click', ()=>{ renderStats(); dlg.showModal(); btnOpen.setAttribute('aria-expanded','true'); });
  btnClose.addEventListener('click', ()=>{ dlg.close(); btnOpen.setAttribute('aria-expanded','false'); });

  // Share – לוקחים את ההיסטוריה מתוך ה-state השמור + ניחושים שהושלמו היום
  E('btnShare').addEventListener('click', ()=>{
    const state = loadState();
    const today = todayKey();
    // שחזור היסטוריית השורות המוגשות מה־state (guesses)
    const history = [];
    const guesses = (state && state.date===today ? (state.guesses||[]) : []);
    guesses.forEach(g=>{
      const marks = scoreGuess(g, answer);
      history.push({guess:g, marks});
    });
    // אם המשחק כבר הסתיים – ננסה לחשב tries אמיתי מהסטטיסטיקה
    const stats = loadStats();
    const didPlayToday = stats.lastDate===today;
    const triesOrX = (didPlayToday && stats.lastWin) ? history.length : 'X';
    const text = buildShareText(history, answer, triesOrX);
    navigator.clipboard.writeText(text).then(()=>toast('הועתק ללוח!')).catch(()=>toast('שגיאה בהעתקה'));
  });

})();
</script>
</body>
</html>
