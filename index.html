<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>×•×•×¨×“×œ×•×Ÿ</title>
<style>
@font-face{font-family:'Normal093';src:url('./Normal0.93-Regular.woff') format('woff');font-weight:400;font-style:normal;font-display:swap}
@font-face{font-family:'Normal093';src:url('./Normal0.93-Medium.woff') format('woff');font-weight:500;font-style:normal;font-display:swap}
@font-face{font-family:'Normal093';src:url('./Normal0.93-Bold.woff') format('woff');font-weight:700;font-style:normal;font-display:swap}
:root{ --bg:#0b0c0f; --panel:#0f1218; --fg:#e7ecf3; --muted:#9aa8b8; --tile:#111723; --tile-border:#1e2633; --miss:#2a3342; --near:#f7b633; --hit:#22c55e; --key:#1b2230; --key-fg:#e7ecf3; --ring:#2d384a; }
@media (prefers-color-scheme: light){
  :root{ --bg:#ffffff; --panel:#f7f7f8; --fg:#0f172a; --muted:#64748b; --tile:#e9eef5; --tile-border:#cbd5e1; --miss:#cbd5e1; --near:#f59e0b; --hit:#22c55e; --key:#e5e7eb; --key-fg:#0f172a; --ring:#d1d5db; }
}
*{box-sizing:border-box}
body{margin:0; background:var(--bg); color:var(--fg); font:16px/1.45 "Normal093",system-ui,-apple-system,"Segoe UI",Arial,sans-serif}
button,input,select,textarea{font-family:inherit}
header{position:sticky; top:0; z-index:10; background:var(--panel); border-bottom:1px solid var(--ring)}
.bar{max-width:920px; margin:0 auto; padding:12px 14px; display:flex; gap:12px; align-items:center; justify-content:space-between}
nav[role="tablist"]{display:flex; gap:8px; order:-1}
.tab,.btn{border:1px solid var(--ring); background:transparent; color:var(--fg); padding:8px 12px; border-radius:12px; cursor:pointer}
.tab[aria-selected="true"]{background:var(--fg); color:var(--bg)}
h1{ margin:0  font-size:28px; font-weight:700; text-align:center; }
main{max-width:920px; margin:0 auto; padding:20px 14px 40px}
.section{display:none}
.section[aria-hidden="false"]{display:block}
.grid{display:grid; gap:8px; margin:22px auto; justify-content:center}
.row{display:grid; grid-template-columns:repeat(var(--len),min(64px,13.2vw)); gap:8px}
.tile{display:flex; align-items:center; justify-content:center; border:2px solid var(--tile-border); background:var(--tile);
      font-weight:500; font-size:min(42px,9.2vw); aspect-ratio:1; border-radius:10px}
.tile.filled{border-color:#8091a7}
.tile.hit{background:var(--hit); color:#fff; border-color:var(--hit)}
.tile.near{background:var(--near); color:#fff; border-color:var(--near)}
.tile.miss{background:var(--miss); color:#a8b3c2; border-color:var(--miss)}
.kbd{display:grid; gap:10px; justify-content:center; margin:20px auto; width:100%}
.kbd-row{display:flex; gap:8px; justify-content:center; flex-wrap:wrap}
.key{padding:16px 14px; min-width:40px; border:1px solid var(--ring); border-radius:10px; background:var(--key); color:var(--key-fg); cursor:pointer; font-weight:400;}
.wide{min-width:72px}
.toast{position:fixed; left:50%; transform:translateX(-50%); top:72px; background:#0f172a; color:#fff; padding:10px 14px; border-radius:10px; opacity:0; transition:opacity .2s; pointer-events:none; border:1px solid var(--ring)}
.toast.show{opacity:1}
.share{display:flex; gap:8px; justify-content:center; align-items:center; flex-wrap:wrap; margin-top:12px}
footer{margin:24px 0 36px; text-align:center; color:var(--muted); font-size:12px}
@keyframes pop { 0%{transform:scale(0.9)} 40%{transform:scale(1.1)} 100%{transform:scale(1)} }
.tile.pop{animation:pop .12s ease}
#countdown{display:none!important}

nav[role="tablist"], #btnStats, #btnTheme, #custom { display: none !important; }


/* key color sync with board */
.key.hit{ background:#3aa394; color:#fff; border-color:#3aa394; }
.key.near{ background:#d3ad69; color:#fff; border-color:#d3ad69; }
.key.miss{ background:#444; color:#eee; border-color:#444; }
</style>

<style id="wordlon-patch">
/* ===== Minimal patch (no structural changes) ===== */

/* 4) Ensure h1 rule parses correctly and stays centered */
h1{ margin:0; font-size:28px; font-weight:700; text-align:center; }

/* 3) Center the title area and reduce space to the board */
.bar{ justify-content:center; }
main{ padding-top:8px; }           /* was 20px */
.grid{ margin:10px auto; }         /* was 22px */

/* 1) Prevent iPhone line breaks in keyboard rows (allow horizontal scroll if needed) */
.kbd-row{ flex-wrap:nowrap; overflow-x:auto; -webkit-overflow-scrolling:touch; }
.kbd-row::-webkit-scrollbar{ display:none; }
.key{ flex:0 0 auto; }

/* 2) Make keyboard font slightly larger (kept modest to avoid overflow) */
.kbd .key{ font-size:18px; padding:18px 16px; }
@media (min-width:640px){
  .kbd .key{ font-size:20px; padding:20px 18px; }
}
</style>


<style id="wordlon-mobile-fit">
/* ===== Mobile fit patch (non-destructive) ===== */

/* 1) Keyboard fits screen width on mobile, no horizontal scroll */
@media (max-width: 420px){
  .kbd{ max-width:100vw; padding-left:6px; padding-right:6px; }
  .kbd-row{
    flex-wrap:nowrap;            /* keep single row */
    overflow-x:hidden;           /* avoid scroll */
    gap:4px;                     /* tighter spacing */
  }
  .kbd .key, .key{
    flex:1 1 0;                  /* keys shrink evenly to fit */
    min-width:0;                 /* allow shrinking below intrinsic width */
    padding:14px 8px;
    font-size:16px;
  }
}

/* Slightly larger small phones (e.g., up to 480px) */
@media (min-width:421px) and (max-width: 480px){
  .kbd{ max-width:100vw; padding-left:8px; padding-right:8px; }
  .kbd-row{ gap:6px; }
  .kbd .key, .key{
    flex:1 1 0;
    min-width:0;
    padding:16px 10px;
    font-size:18px;
  }
}

/* 2) Remove the line/extra gap under the title and tighten spacing */
.bar{ border-bottom:none !important; box-shadow:none !important; }
h1{ margin-bottom:6px !important; }
main{ padding-top:6px !important; }
.grid{ margin-top:8px !important; }

/* 3) Slightly shrink the board on small iPhones (e.g., iPhone SE/12 mini width â‰ˆ 375px) */
@media (max-width: 380px){
  .grid{
    transform: scale(0.92);
    transform-origin: top center;
  }
  /* reclaim a bit of space below after scaling */
  .grid{ margin-bottom:8px; }
}
</style>


<style id="wordlon-uniform-keys-and-spacing">
/* ===== Uniform keys + tighter spacing (non-destructive) ===== */

/* Try to use provided Medium font if exists; otherwise rely on weight 500 */
@font-face{
  font-family: 'WordlonKeyMedium';
  src: url('Normal-Medium.woff') format('woff');
  font-weight: 500;
  font-style: normal;
  font-display: swap;
}

/* Global tightening: remove divider under title and compress vertical space */
.bar{ border-bottom:none !important; box-shadow:none !important; }
h1{ margin-top:0 !important; margin-bottom:4px !important; text-align:center; }
main{ padding-top:4px !important; }
.grid{ margin:6px auto !important; }
.kbd{ margin-top:6px !important; margin-bottom:6px !important; }

/* Keys: consistent height & bigger type, medium weight */
.kbd .key, .key{
  font-family: 'WordlonKeyMedium', inherit;
  font-weight: 500;
  line-height:1;
  height: clamp(42px, 7.5vh, 54px);
  padding: 0 10px;
  font-size: clamp(16px, 5vw, 22px);
  display:flex; align-items:center; justify-content:center;
  border-radius: 8px;
}

/* Mobile layout: make rows fit the viewport width without horizontal scroll */
@media (max-width: 420px){
  .kbd{ max-width:100vw; padding-left:6px; padding-right:6px; }
  .kbd-row{
    display:flex;
    flex-wrap:nowrap;
    gap:4px;
    justify-content:space-between;
  }
  .kbd .key, .key{
    flex:1 1 0;
    min-width:0;     /* allow even shrinking */
  }
}

/* Slightly wider small phones */
@media (min-width:421px) and (max-width:480px){
  .kbd{ max-width:100vw; padding-left:8px; padding-right:8px; }
  .kbd-row{ gap:6px; }
  .kbd .key, .key{ flex:1 1 0; min-width:0; }
}

/* Keep keyboard state colors legible */
.kbd .key[data-kstate]{ color:#fff !important; }
.kbd .key{ transition: background-color .15s ease, border-color .15s ease; }
</style>

<script id="wordlon-enterkey-and-tighten">
(function(){
  // 3) Replace "×©×œ×™×—×”" with â, try common selectors
  function replaceEnterVisual(){
    var keys = document.querySelectorAll('.kbd .key, .key');
    keys.forEach(function(k){
      var dk = (k.getAttribute('data-key')||"").toLowerCase();
      var txt = (k.textContent||"").trim();
      if(dk === 'enter' || txt === '×©×œ×™×—×”'){
        if(k.textContent !== 'â'){
          k.textContent = 'â';
        }
        k.setAttribute('aria-label','Enter');
      }
    });
  }
  if(document.readyState==='loading'){
    document.addEventListener('DOMContentLoaded', replaceEnterVisual, {once:true});
  }else{
    replaceEnterVisual();
  }
  // Run again after any DOM changes near the keyboard
  var kb = document.querySelector('.kbd') || document.body;
  if(kb){
    var mo = new MutationObserver(function(){ replaceEnterVisual(); });
    mo.observe(kb, {subtree:true, childList:true, characterData:true});
  }
})();
</script>

</head>
<body>
<header>
  <div class="bar">
    <nav role="tablist" aria-label="××¦×‘×™×">
      <button class="tab" id="tabDaily" role="tab" aria-selected="true" data-target="daily">×•×•×¨×“×œ×•×Ÿ ×”×™×•××™</button>
      <button class="tab" id="tabCustom" role="tab" aria-selected="false" data-target="custom">×”×ª×××” ××™×©×™×ª</button>
    </nav>
    <h1>×•×•×¨×“×œ×•×Ÿ</h1>
    <div style="display:flex; gap:8px; align-items:center">
      <button id="btnStats" class="btn" title="×¡×˜×˜×™×¡×˜×™×§×•×ª">ğŸ“Š</button>
      <button id="btnTheme" class="btn" title="××¦×‘ ×›×”×”"><span style="font-size:18px">â˜¾</span></button>
    </div>
  </div>
</header>

<!-- Include lists BEFORE main script -->
<script src="./allowedwords.js"></script>
<script src="./wordlons.js"></script>

<main>
  <section id="daily" class="section" aria-hidden="false">
    <div id="dailyBoard" class="grid"></div>
    <div id="dailyKbd" class="kbd" aria-label="××§×œ×“×ª ×•×™×¨×˜×•××œ×™×ª"></div>
    <div class="share" id="dailyShare"></div>
    <div id="countdown" style="text-align:center; color:var(--muted); margin-top:6px"></div>
  </section>

  <section id="custom" class="section" aria-hidden="true">
    <div style="display:flex; gap:10px; align-items:center; justify-content:center; flex-wrap:wrap">
      <input id="secretInput" dir="rtl" inputmode="text" maxlength="10" placeholder="××™×œ×” (3â€“10)" style="padding:10px 12px; border-radius:10px; border:1px solid var(--ring); background:var(--panel); color:var(--fg)">
      <button id="makeLink" class="btn">×§×™×©×•×¨</button>
    </div>
    <div id="linkOut" class="share"></div>
    <hr style="margin:22px 0; opacity:0.2">
    <div id="customBoard" class="grid"></div>
    <div id="customKbd" class="kbd" aria-label="××§×œ×“×ª ×•×™×¨×˜×•××œ×™×ª"></div>
  </section>
</main>

<footer>
  <span>&copy; ××œ×•×Ÿ ×ª×™×™×¨ <span id="year">2025</span></span>
</footer>

<div class="toast" id="toast" role="status" aria-live="polite"></div>

<dialog id="dlgStats">
  <div style="padding:14px; border-bottom:1px solid var(--ring); display:flex; justify-content:space-between; align-items:center">
    <strong>×¡×˜×˜×™×¡×˜×™×§×•×ª</strong>
    <button class="btn" id="dlgClose">âœ–</button>
  </div>
  <div style="padding:16px">
    <div style="display:flex; gap:16px; justify-content:space-around; text-align:center">
      <div><b id="stPlayed" style="display:block; font-size:32px">0</b>××©×—×§×™×</div>
      <div><b id="stWin" style="display:block; font-size:32px">0</b>× ×™×¦×—×•× ×•×ª</div>
      <div><b id="stStreak" style="display:block; font-size:32px">0</b>×¨×¦×£</div>
      <div><b id="stBest" style="display:block; font-size:32px">0</b>×©×™× ×¨×¦×£</div>
    </div>
  </div>
</dialog>

<script>
'use strict';
function ready(fn){ if (document.readyState!=='loading') fn(); else document.addEventListener('DOMContentLoaded', fn); }
ready(()=>{
  const E = id => document.getElementById(id);
  const el = {
    tabDaily:E('tabDaily'), tabCustom:E('tabCustom'),
    daily:E('daily'), custom:E('custom'),
    dailyBoard:E('dailyBoard'), dailyKbd:E('dailyKbd'),
    dailyShare:E('dailyShare'), countdown:E('countdown'),
    secretInput:E('secretInput'), makeLink:E('makeLink'), linkOut:E('linkOut'),
    customBoard:E('customBoard'), customKbd:E('customKbd'),
    btnStats:E('btnStats'), btnTheme:E('btnTheme'),
    dlgStats:E('dlgStats'), dlgClose:E('dlgClose'),
    stPlayed:E('stPlayed'), stWin:E('stWin'), stStreak:E('stStreak'), stBest:E('stBest'),
  };
  // ---- Daily persistence (local midnight) ----
  const storageKey = 'wordlon.daily';
  function todayStr(){
    const d = new Date(); // user's local tz
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const da = String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${da}`;
  }
  function loadDaily(){
    try{ return JSON.parse(localStorage.getItem(storageKey) || '{}'); }catch(e){ return {}; }
  }
  function saveDaily(obj){
    try{ localStorage.setItem(storageKey, JSON.stringify(obj)); }catch(e){}
  }
  function showWinMessageAttempt(attempt){
    const msgs = ["×©×™×•","×•×•××•","××“×”×™×","××¢×•×œ×”","××•×©×œ×","× ×™×¦×œ×ª ×‘×¨×’×¢ ×”××—×¨×•×Ÿ"];
    const msg = msgs[(attempt-1)|0] || msgs[msgs.length-1];
    toast(msg);
  }


  // Theme
  (function(){ const saved = localStorage.getItem('theme'); if (saved==='light') document.documentElement.setAttribute('data-theme','light'); })();
  el.btnTheme.addEventListener('click', ()=>{
    const root=document.documentElement; const isLight=root.getAttribute('data-theme')==='light';
    root.setAttribute('data-theme', isLight ? '' : 'light'); localStorage.setItem('theme', isLight ? '' : 'light');
  });

  // Debug banner
  function showDebug(msg){
    let b = document.getElementById('dbg');
    if (!b){
      b = document.createElement('div');
      b.id='dbg';
      b.style.cssText='position:fixed;bottom:6px;left:6px;background:#000c;color:#fff;padding:6px 10px;border:1px solid #333;border-radius:8px;font-size:12px;z-index:9999';
      document.body.appendChild(b);
    }
    b.textContent = msg;
  }

  // Normalize
  const finals = {'×š':'×›','×':'×','×Ÿ':'× ','×£':'×¤','×¥':'×¦'};
  const norm = s => s.normalize('NFC').replace(/\s+/g,'').replace(/[×´"]/g,'').replace(/[×š××Ÿ×£×¥]/g, ch => finals[ch]).trim();

  // Pull global lists (support both variable names)
  const allowedRaw = (typeof allowedWords !== 'undefined' ? allowedWords :
                      (typeof hebWords !== 'undefined' ? hebWords : ''));
  const answersRaw = (typeof wordlons !== 'undefined' ? wordlons :
                      (typeof listOfWords !== 'undefined' ? listOfWords : []));

  // Build ALLOWED set
  let ALLOWED = new Set();
  if (Array.isArray(allowedRaw)){
    ALLOWED = new Set(allowedRaw.map(norm));
  }else if (typeof allowedRaw === 'string'){
    const parts = allowedRaw.split(/[\s,]+/).filter(Boolean);
    ALLOWED = new Set(parts.map(norm));
  }
  // ANSWERS5
  const ANSWERS5 = (Array.isArray(answersRaw) ? answersRaw : [])
    .map(s => (''+s).trim())
    .filter(s => /^[×-×ª×š××Ÿ×£×¥]{5}$/.test(s));

  showDebug(`ALLOWED: ${ALLOWED.size} | ANSWERS5: ${ANSWERS5.length}`);

  if (ANSWERS5.length === 0){ ANSWERS5.push('×©×œ×•×'); }
  if (ALLOWED.size === 0){
    ['×©×œ×•×','×—×œ×•×','×—×œ×•×Ÿ','×¢×•×œ×','×‘×“×™×§×”','××•×œ×¤×Ÿ','×ª××•× ×”'].forEach(w=>ALLOWED.add(norm(w)));
  }

  // Daily answer
  const tz='Asia/Jerusalem';
  function dailyIndex(epoch = new Date('2025-01-01T00:00:00+02:00')){
    const now = new Date();
    const days = Math.floor((now - epoch) / 86400000);
    return ANSWERS5.length ? (days % ANSWERS5.length) : 0;
  }
  function getDailyAnswer(){ return ANSWERS5[dailyIndex()]; }

  // UI + keyboard + game
  const rowsCount = 6;
  const hebRows = [
    ['×¤','×•','×˜','×','×¨','×§'],
    ['×œ','×—','×™','×¢','×›','×’','×“','×©'],
    ['×ª','×¦','×','× ','×”','×‘','×¡','×–']
  ];
  function isHeb(s){ return /^[×-×ª×š××Ÿ×£×¥]+$/.test(s); }

  function buildBoard(container,len=5,rows=rowsCount){
    container.style.setProperty('--len', len);
    container.innerHTML='';
    for (let r=0;r<rows;r++){
      const row=document.createElement('div'); row.className='row';
      for (let c=0;c<len;c++){
        const t=document.createElement('div'); t.className='tile'; t.dataset.row=r; t.dataset.col=c;
        row.appendChild(t);
      }
      container.appendChild(row);
    }
  }
  function buildKeyboard(container,onKey){
    container.innerHTML='';
    hebRows.forEach((row,ri)=>{
      const R=document.createElement('div'); R.className='kbd-row';
      row.forEach(ch=>{ const b=document.createElement('button'); b.className='key'; b.textContent=ch; b.onclick=()=>onKey(ch); R.appendChild(b); });
      if (ri===2){
        const enter=document.createElement('button'); enter.className='key wide'; enter.textContent='×©×œ×™×—×”'; enter.onclick=()=>onKey('ENTER'); R.prepend(enter);
        const bk=document.createElement('button'); bk.className='key wide'; bk.textContent='âŒ«'; bk.onclick=()=>onKey('BACK'); R.appendChild(bk);
      }
      container.appendChild(R);
    });
  }
  const lettersEqual = (a,b)=> (finals[a]||a) === (finals[b]||b);
  function scoreGuess(guess,answer){
    const n=answer.length, res=Array(n).fill('miss'), ans=answer.split(''), g=guess.split('');
    for (let i=0;i<n;i++){ if (lettersEqual(g[i],ans[i])){ res[i]='hit'; ans[i]=null; g[i]=null; } }
    for (let i=0;i<n;i++){ if (g[i]==null) continue; const idx=ans.findIndex(ch=>ch && lettersEqual(ch,g[i])); if (idx>-1){ res[i]='near'; ans[idx]=null; } }
    return res;
  }

  function toast(msg){ const t=E('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 1200); }

  function Game({boardEl,kbdEl,answer,mode='daily',shareEl,onWinLose}){
    const len=answer.length; let curRow=0, curCol=0, done=false;
    buildBoard(boardEl,len); buildKeyboard(kbdEl, handleKey);
    const tiles=Array.from({length:rowsCount},()=>Array(len).fill('')); let sessionGuesses=[];
const keyStates={};
    const tileAt=(r,c)=>boardEl.children[r].children[c];

    function updateTiles(popIndex=null){
      for (let c=0;c<len;c++){
        const t=tileAt(curRow,c); t.textContent=tiles[curRow][c]||'';
        t.classList.toggle('filled', !!tiles[curRow][c]);
        if (popIndex===c){ t.classList.remove('pop'); void t.offsetWidth; t.classList.add('pop'); }
      }
    }
    function paintKeys(){
      for (const [ch,state] of Object.entries(keyStates)){
        [...kbdEl.querySelectorAll('.key')].filter(b=>b.textContent===ch).forEach(b=>b.dataset.state=state);
      }
    }
    function revealRow(marks){
      const rEl = boardEl.children[curRow];
      [...rEl.children].forEach((t,i)=>{ t.classList.remove('hit','near','miss'); t.classList.add(marks[i]); });
    }
    function commitGuess(){
      const guess = tiles[curRow].join('');
      sessionGuesses.push(guess);
      if (guess.length!==len){ rowShake(); toast('×œ× ××¡×¤×™×§ ××•×ª×™×•×ª'); return; }
      if (!isHeb(guess)){ rowShake(); toast('×¨×§ ×¢×‘×¨×™×ª'); return; }

      if (mode==='daily'){
        if (!ALLOWED.has(norm(guess))){
          rowShake(); toast('××™×œ×” ×œ× ××•×›×¨×ª'); return;
        }
      }
      const marks=scoreGuess(guess,answer);
      revealRow(marks);
      // --- persist daily state ---
      if (mode==='daily'){
        const isWin = (guess === answer);
        const lastRow = (curRow >= (rowsCount-1));
        if (isWin || lastRow){
          try{ saveDaily({date: todayStr(), guesses: sessionGuesses.slice(), finished: true}); }catch(e){}
        } else {
          try{ saveDaily({date: todayStr(), guesses: sessionGuesses.slice(), finished: false}); }catch(e){}
        }
      }

      guess.split('').forEach((ch,i)=>{
        const m=marks[i]; const prev=keyStates[ch]; const rank={miss:0,near:1,hit:2};
        if (!prev || rank[m]>rank[prev]) keyStates[ch]=m;
      });
      paintKeys();
      const win = marks.every(m=>'hit'===m);
      curRow++; curCol=0;
      if (win){ done=true;
      saveDaily({date: todayStr(), played: true, win: true, tries: curRow, guesses: sessionGuesses, answer});
      showWinMessageAttempt(curRow);
       onWinLose && onWinLose(true,curRow); return; }
      if (curRow>=rowsCount){  toast('×”××™×œ×” ×”×™×™×ª×”: '+answer); done=true; onWinLose && onWinLose(false,curRow); return; 
      saveDaily({date: todayStr(), played: true, win: false, tries: rowsCount, guesses: sessionGuesses, answer});
      }
    }
    function rowShake(){ const row=boardEl.children[curRow]; row.classList.remove('shake'); void row.offsetWidth; row.classList.add('shake'); }
    function handleKey(k){
      if (done) return;
      if (k==='ENTER') return commitGuess();
      if (k==='BACK'){ if (curCol>0){ curCol--; tiles[curRow][curCol]=''; updateTiles(); } return; }
      if (k.length===1){
        if (curCol>=len) return;
        if (!/^[×-×ª×š××Ÿ×£×¥]$/.test(k)) return;
        tiles[curRow][curCol]=k; updateTiles(curCol); curCol++;
      }
    }
    window.addEventListener('keydown', ev=>{
      const k=ev.key;
      if (k==='Enter') return handleKey('ENTER');
      if (k==='Backspace') return handleKey('BACK');
      if (/^[×-×ª]$/.test(k)) return handleKey(k);
    });
    return {handleKey};
  }

  // Tabs + Stats + Countdown
  const baseURL = location.origin + location.pathname.replace(/index\.html?$/,'');
  const statsKey='wordlon.stats';
  function loadStats(){ try{ return JSON.parse(localStorage.getItem(statsKey)) || {played:0,wins:0,streak:0,best:0,lastDate:''}; } catch(e){ return {played:0,wins:0,streak:0,best:0,lastDate:''}; } }
  function saveStats(s){ localStorage.setItem(statsKey, JSON.stringify(s)); }
  function updateStatsUI(){ const s=loadStats(); el.stPlayed.textContent=s.played; el.stWin.textContent=s.wins; el.stStreak.textContent=s.streak; el.stBest.textContent=s.best; }
  el.btnStats.addEventListener('click', ()=>{ updateStatsUI(); el.dlgStats.showModal(); });
  el.dlgClose.addEventListener('click', ()=>el.dlgStats.close());
  function selectTab(id){
    [el.tabDaily, el.tabCustom].forEach(t=>{ const on=t.dataset.target===id; t.setAttribute('aria-selected', on?'true':'false'); });
    [el.daily, el.custom].forEach(s=>{ s.setAttribute('aria-hidden', s.id===id ? 'false':'true'); });
  }
  el.tabDaily.addEventListener('click', ()=>selectTab('daily'));
  el.tabCustom.addEventListener('click', ()=>selectTab('custom'));

  function maybeLoadCustomFromLink(){
    const m2=location.hash.match(/#custom=([^&]+)/);
    if (m2){ const secret=decodeURIComponent(m2[1]); if (/^[×-×ª×š××Ÿ×£×¥]{3,10}$/.test(secret)){ selectTab('custom'); return startCustomGame(secret); } }
  }
  function startCustomGame(secret){
    el.customBoard.innerHTML=''; el.customKbd.innerHTML=''; el.linkOut.innerHTML='';
    Game({boardEl: el.customBoard, kbdEl: el.customKbd, answer:secret, mode:'custom', shareEl:el.linkOut});
  }
  window.addEventListener('hashchange', maybeLoadCustomFromLink);

  document.getElementById('year').textContent = new Date().getFullYear();

  // Boot
  const dailyAnswer = getDailyAnswer();
  const dailyGame = Game({boardEl: el.dailyBoard, kbdEl: el.dailyKbd, answer:dailyAnswer, mode:'daily', shareEl:el.dailyShare, onWinLose:()=>{}});

  
  (function replayIfPlayed(){
    const st = loadDaily();
    if (st && st.date === todayStr() && Array.isArray(st.guesses) && st.guesses.length){
      function typeWord(word){
        for (const ch of word){ window.dispatchEvent(new KeyboardEvent('keydown', {key: ch})); }
        window.dispatchEvent(new KeyboardEvent('keydown', {key: 'Enter'}));
      }
      st.guesses.slice(0, rowsCount).forEach(typeWord);
    }
  })();
function updateCountdown(){
    const now=new Date();
    const midnight=new Date(); midnight.setHours(24,0,0,0);
    const diff=midnight-now;
    const h=String(Math.floor(diff/3_600_000)).padStart(2,'0');
    const m=String(Math.floor((diff%3_600_000)/60_000)).padStart(2,'0');
    const s=String(Math.floor((diff%60_000)/1000)).padStart(2,'0');
    el.countdown.textContent=`${h}:${m}:${s}`;
  }
  setInterval(updateCountdown, 1000);
  updateCountdown();
  maybeLoadCustomFromLink();
});
</script>

<style id="wordlon-keycolor-patch">
/* Minimal keyboard coloring patch (non-destructive) */
/* Priority is managed in JS; here we just ensure legible text */
.kbd .key[data-kstate]{ color:#fff !important; }
/* Allow smooth color transition without changing layout */
.kbd .key{ transition: background-color .2s ease; }
</style>
<script id="wordlon-keycolor-script">
(function(){
  function getBoardColor(status){
    // Try to infer the exact board color already used on tiles
    var probe = document.querySelector('[data-state="'+status+'"]') 
             || document.querySelector('.'+status);
    if(probe){
      var cs = getComputedStyle(probe);
      var bg = cs.backgroundColor || cs.background || "";
      if(bg && bg !== "rgba(0, 0, 0, 0)" && bg !== "transparent"){ return bg; }
    }
    // Fallbacks (kept only as last resort)
    switch(status){
      case "correct": return "#538d4e";   // Wordle green
      case "present": return "#b59f3b";   // Wordle yellow
      case "absent":  return "#3a3a3c";   // Wordle gray (dark mode)
      default: return "";
    }
  }

  function norm(ch){
    return (ch || "").trim().toLowerCase();
  }

  function statusRank(s){
    // Higher is stronger. correct > present > absent
    if(s==="correct") return 3;
    if(s==="present") return 2;
    if(s==="absent")  return 1;
    return 0;
  }

  function collectBoardStatuses(){
    var map = Object.create(null);
    var tiles = Array.from(document.querySelectorAll('[data-state]'));
    if(tiles.length===0){
      tiles = Array.from(document.querySelectorAll('.correct, .present, .absent'));
    }
    tiles.forEach(function(el){
      var s = el.getAttribute('data-state') || 
              (el.classList.contains('correct') ? 'correct' :
               el.classList.contains('present') ? 'present' :
               el.classList.contains('absent')  ? 'absent'  : '');
      if(!s) return;
      var ch = norm(el.textContent);
      if(!ch) return;
      var prev = map[ch];
      if(!prev || statusRank(s) > statusRank(prev)){ map[ch] = s; }
    });
    return map;
  }

  function applyToKeyboard(map){
    var green = getBoardColor("correct");
    var yellow = getBoardColor("present");
    var gray = getBoardColor("absent");
    var keys = document.querySelectorAll('.kbd .key, .key'); // be liberal

    keys.forEach(function(key){
      var k = norm(key.getAttribute('data-key') || key.textContent);
      var s = map[k];
      if(s){
        key.setAttribute('data-kstate', s);
        var bg = s==="correct" ? green : s==="present" ? yellow : gray;
        key.style.backgroundColor = bg;
        key.style.borderColor = bg;
        key.style.color = "#fff";
      }else{
        key.removeAttribute('data-kstate');
        key.style.backgroundColor = "";
        key.style.borderColor = "";
        key.style.color = "";
      }
    });
  }

  function update(){ applyToKeyboard(collectBoardStatuses()); }

  // Run on DOM ready
  if(document.readyState === "loading"){
    document.addEventListener("DOMContentLoaded", update, {once:true});
  }else{
    update();
  }

  // Observe board changes to keep in sync without touching game logic
  var grid = document.querySelector('.grid, .board, main, body');
  if(grid){
    var mo = new MutationObserver(function(muts){
      var needs = muts.some(function(m){
        return (m.type === "attributes" && (m.attributeName === "data-state" || m.target.classList)) ||
               (m.type === "childList");
      });
      if(needs){ update(); }
    });
    mo.observe(grid, { subtree:true, childList:true, attributes:true, attributeFilter:["data-state","class"] });
  }

  // Also re-run after key presses (in case the game updates after input)
  window.addEventListener('keyup', function(){ setTimeout(update, 0); }, true);
  window.addEventListener('click', function(e){
    if(e.target && (e.target.classList && e.target.classList.contains('key'))) {
      setTimeout(update, 0);
    }
  }, true);
})();
</script>

</body>
</html>
