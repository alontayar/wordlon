<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>וורדלון</title>

  
  <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-QECD9KCP92"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-QECD9KCP92');
</script>

  
<style>
@font-face{font-family:'NewNormal';src:url('./NewNormal-Regular.woff') format('woff');font-weight:400;font-style:normal;font-display:swap}
@font-face{font-family:'NewNormal';src:url('./NewNormal-SemiBold.woff') format('woff');font-weight:500;font-style:normal;font-display:swap}
@font-face{font-family:'NewNormal';src:url('./NewNormal-Bold.woff') format('woff');font-weight:700;font-style:normal;font-display:swap}
:root{ --bg:#121213; --panel:#121213; --fg:#ffffff; --muted:#818384; --tile:#121213; --tile-border:#3a3a3c; --miss:#3a3a3c; --near:#b59f3b; --hit:#538d4e; --key:#818384; --key-fg:#ffffff; --ring:#3a3a3c; }
@media (prefers-color-scheme: light){
  :root{ --bg:#ffffff; --panel:#ffffff; --fg:#1a1a1b; --muted:#787c7e; --tile:#ffffff; --tile-border:#d3d6da; --miss:#787c7e; --near:#c9b458; --hit:#6aaa64; --key:#d3d6da; --key-fg:#1a1a1b; --ring:#d3d6da; }
}
*{box-sizing:border-box}
button{font-family:"NewNormal",system-ui,-apple-system,sans-serif !important;}
body{margin:0; background:var(--bg); color:var(--fg); font-size:16px; line-height:1.45; font-family:"NewNormal",system-ui,-apple-system,"Segoe UI",Arial,sans-serif; overflow-x:hidden}
input,select,textarea{font-family:inherit}
header{position:sticky; top:0; z-index:10; background:var(--panel); border-bottom:none; padding-top:12px}
.bar{max-width:920px; margin:0 auto; padding:4px 14px; display:flex; gap:12px; align-items:center; justify-content:space-between}
nav[role="tablist"]{display:flex; gap:8px; order:-1}
.tab,.btn{border:1px solid var(--ring); background:transparent; color:var(--fg); padding:8px 12px; border-radius:12px; cursor:pointer}
.tab[aria-selected="true"]{background:var(--fg); color:var(--bg)}
h1{ margin:0  font-size:28px; font-weight:700; text-align:center; }
main{max-width:920px; margin:0 auto; padding:20px 14px 40px}
.section{display:none}
.section[aria-hidden="false"]{display:block}
.grid{display:grid; gap:8px; margin:22px auto; justify-content:center}
.row{display:grid; grid-template-columns:repeat(var(--len),min(64px,13.2vw)); gap:8px}
.tile{display:flex; align-items:center; justify-content:center; border:2px solid var(--tile-border); background:var(--tile);
      font-weight:700; font-size:min(42px,9.2vw); aspect-ratio:1; border-radius:10px}
.tile.filled{border-color:#8091a7}
.tile.hit{background:var(--hit); color:#fff; border-color:var(--hit)}
.tile.near{background:var(--near); color:#fff; border-color:var(--near)}
.tile.miss{background:var(--miss); color:#fff; border-color:var(--miss)}
.kbd{display:grid; gap:10px; justify-content:center; margin:20px auto; width:100%}
.kbd-row{display:flex; gap:8px; justify-content:center; flex-wrap:wrap}
.key{padding:16px 14px; min-width:40px; border:1px solid var(--ring); border-radius:10px; background:var(--key); color:var(--key-fg); cursor:pointer; font-weight:500;}
.wide{min-width:72px}
.toast{position:fixed; left:50%; transform:translateX(-50%); top:72px; background:#0f172a; color:#fff; padding:10px 14px; border-radius:10px; opacity:0; transition:opacity .2s; pointer-events:none; border:1px solid var(--ring)}
.toast.show{opacity:1}
.share{display:flex; gap:8px; justify-content:center; align-items:center; flex-wrap:wrap; margin-top:12px}
footer{margin:24px 0 36px; text-align:center; color:var(--muted); font-size:12px}
@keyframes pop { 0%{transform:scale(0.9)} 40%{transform:scale(1.1)} 100%{transform:scale(1)} }
.tile.pop{animation:pop .12s ease}
.tile{ transition: transform 0s; }
@keyframes dlg-fade {
  from { opacity:0; transform:translateY(-20px) scale(0.95); }
  to   { opacity:1; transform:translateY(0)    scale(1);    }
}
dialog[open] { animation: dlg-fade 0.35s cubic-bezier(0.16,1,0.3,1); }
#countdown{display:none!important}

nav[role="tablist"], #btnTheme, #custom { display: none !important; }


/* key color sync with board */
.key.hit{ background:var(--hit); color:#fff; border-color:var(--hit); }
.key.near{ background:var(--near); color:#fff; border-color:var(--near); }
.key.miss{ background:var(--miss); color:#fff; border-color:var(--miss); }
</style>












<style id="wordlon-clean">

/* Bar */
.bar{ display:flex; align-items:center; justify-content:space-between; border-bottom:none !important; box-shadow:none !important; width:calc(5 * (min(64px,13.2vw) + 5px) - 5px); margin:0 auto; padding:4px 0; }
h1{ margin:0 0 2px; font-size:28px; font-weight:700; text-align:center; }
main{ padding-top:2px !important; }

/* Tiles */
.grid{ margin:4px auto !important; gap:5px; }
.row{ gap:5px; }

/* Keyboard */
.kbd{ display:flex; flex-direction:column; gap:7px; align-items:center; margin:22px auto 2px !important; }
.kbd-row{ display:flex; gap:4px; justify-content:center; flex-wrap:nowrap; }
.key{
  width:clamp(28px,6.2vw,40px);
  height:clamp(42px,9vw,50px);
  flex:0 0 auto;
  border:1px solid var(--ring);
  border-radius:8px;
  background:var(--key);
  color:var(--key-fg);
  cursor:pointer;
  font-weight:500;
  font-size:clamp(18px,4.5vw,24px);
  display:flex; align-items:center; justify-content:center;
  padding:0;
  transition:background-color .15s;
  touch-action:manipulation;
}
.key.hit{ background:var(--hit); color:#fff; border-color:var(--hit); }
.key.near{ background:var(--near); color:#fff; border-color:var(--near); }
.key.miss{ background:var(--miss); color:#fff; border-color:var(--miss); }

/* Icon buttons in header */
.icon-btn{ border:none; background:transparent; color:var(--fg); cursor:pointer; padding:6px; display:flex; align-items:center; justify-content:center; border-radius:8px; }
.icon-btn:hover{ background:var(--tile-border); }
.grid-icons-row{
  display:flex;
  justify-content:space-between;
  align-items:center;
  width: calc(5 * (min(64px,13.2vw) + 5px) - 5px);
  margin: 0 auto 1px;
}

/* Toggle switch */
.toggle-btn{ position:relative; flex-shrink:0; width:48px; height:26px; border-radius:13px; border:none; cursor:pointer; background:var(--miss); transition:background .2s; padding:0; }
.toggle-btn::after{ content:''; position:absolute; top:3px; right:3px; width:20px; height:20px; border-radius:50%; background:#fff; transition:transform .2s; }
.toggle-btn[aria-checked="true"]{ background:var(--hit); }
.toggle-btn[aria-checked="true"]::after{ transform:translateX(-22px); }

/* High contrast */
[data-contrast="true"]{ --hit:#f5793a; --near:#85c0f9; }
[data-theme="light"]{ --bg:#ffffff; --panel:#ffffff; --fg:#1a1a1b; --muted:#787c7e; --tile:#ffffff; --tile-border:#d3d6da; --miss:#787c7e; --near:#c9b458; --hit:#6aaa64; --key:#d3d6da; --key-fg:#1a1a1b; --ring:#d3d6da; }

/* Footer */
footer{ margin:0 0 6px; text-align:center; color:var(--muted); font-size:12px; }

/* Mobile */
@media(max-width:600px){
  .kbd{ margin-top:6px !important; padding:0 16px; box-sizing:border-box; width:100%; max-width:100vw; gap:7px; }
  .kbd-row{ gap:4px; flex-wrap:nowrap; }
  .key{ width:clamp(20px,6vw,27px); height:clamp(42px,10vw,50px); font-size:clamp(18px,5.2vw,24px); border-radius:6px; }
  .grid{ margin-top:2px !important; }
  .row{ grid-template-columns:repeat(var(--len),min(64px,15vw)); gap:4px; }
  .tile{ font-size:min(42px,10vw); }
  main{ padding-top:2px !important; }
  #dailyBoard, #customBoard{ min-height:calc(6 * (min(64px,15vw) + 4px)); }
}
@media(max-width:380px){
  .grid{ transform:scale(0.93); transform-origin:top center; }
}
</style>
</head>
<body>
<div style="display:none">
  <button id="tabDaily" role="tab" aria-selected="true" data-target="daily"></button>
  <button id="tabCustom" role="tab" aria-selected="false" data-target="custom"></button>
</div>
<header style="text-align:center">
  <div class="bar">
    <button id="btnSettings" class="icon-btn" title="הגדרות">
      <svg width="22" height="22" viewBox="0 0 24 24" fill="currentColor">
        <path d="M12 15.5A3.5 3.5 0 0 1 8.5 12 3.5 3.5 0 0 1 12 8.5a3.5 3.5 0 0 1 3.5 3.5 3.5 3.5 0 0 1-3.5 3.5m7.43-2.92c.04-.36.07-.73.07-1.08s-.03-.73-.07-1.08l2.32-1.82c.21-.16.27-.45.13-.69l-2.2-3.8c-.13-.24-.42-.32-.66-.24l-2.74 1.1c-.57-.44-1.18-.8-1.85-1.08L14.92 2.1A.54.54 0 0 0 14.38 1.6h-4.4a.54.54 0 0 0-.53.46L9.09 4.52C8.42 4.8 7.81 5.16 7.24 5.6L4.5 4.5c-.24-.09-.53 0-.66.24l-2.2 3.8c-.14.23-.08.53.13.69l2.32 1.82C4.03 11.27 4 11.63 4 12s.03.73.07 1.08L1.75 14.9c-.21.16-.27.45-.13.69l2.2 3.8c.13.24.42.32.66.24l2.74-1.1c.57.44 1.18.8 1.85 1.08l.36 2.42c.07.26.3.46.57.46h4.4c.27 0 .5-.2.57-.46l.36-2.42c.67-.28 1.28-.64 1.85-1.08l2.74 1.1c.24.09.53 0 .66-.24l2.2-3.8c.14-.23.08-.53-.13-.69l-2.32-1.82z"/>
      </svg>
    </button>
    <h1>וורדלון</h1>
    <button id="btnStats" class="icon-btn" title="סטטיסטיקות">
      <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
        <rect x="1" y="10" width="4" height="9" rx="1"/>
        <rect x="8" y="5" width="4" height="14" rx="1"/>
        <rect x="15" y="1" width="4" height="18" rx="1"/>
      </svg>
    </button>
  </div>
</header>
<div id="lossBanner" style="display:none; position:sticky; top:52px; z-index:9; background:#c0392b; color:#fff; text-align:center; padding:7px 14px; font-size:15px; font-weight:700; letter-spacing:0.04em;"></div>


<script src="./allowedwords.js"></script>
<script src="./wordlons.js"></script>

<main>
  <section id="daily" class="section" aria-hidden="false">
    <div id="dailyBoard" class="grid"></div>
    <div id="dailyKbd" class="kbd" aria-label="מקלדת וירטואלית"></div>
    <div class="share" id="dailyShare"></div>
    <div id="countdown" style="text-align:center; color:var(--muted); margin-top:6px"></div>
  </section>

  <section id="custom" class="section" aria-hidden="true">
    <div style="display:flex; gap:10px; align-items:center; justify-content:center; flex-wrap:wrap">
      <input id="secretInput" dir="rtl" inputmode="text" maxlength="5" placeholder="מילה (5 אותיות)" style="padding:10px 12px; border-radius:10px; border:1px solid var(--ring); background:var(--panel); color:var(--fg)">
      <button id="makeLink" class="btn">קישור</button>
    </div>
    <div id="linkOut" class="share"></div>
    <hr style="margin:22px 0; opacity:0.2">
    <div id="customBoard" class="grid"></div>
    <div id="customKbd" class="kbd" aria-label="מקלדת וירטואלית"></div>
  </section>
</main>

<footer>
  <span>&copy; אלון תייר <span id="year">2025</span></span>
</footer>

<div class="toast" id="toast" role="status" aria-live="polite"></div>

<!-- Settings Dialog -->
<dialog id="dlgSettings" style="background:var(--panel);color:var(--fg);border:1px solid var(--ring);border-radius:16px;padding:0;min-width:300px;max-width:92vw;width:360px;margin-top:60px">
  <div style="padding:14px 16px;display:flex;justify-content:space-between;align-items:center">
    <strong style="font-size:16px">הגדרות</strong>
    <button id="dlgSettingsClose" style="border:none;background:transparent;cursor:pointer;color:var(--fg);padding:4px;display:flex;align-items:center">
      <svg width="20" height="20" viewBox="0 0 22 22" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"><line x1="4" y1="4" x2="18" y2="18"/><line x1="18" y1="4" x2="4" y2="18"/></svg>
    </button>
  </div>
  <div style="padding:18px 20px;display:flex;flex-direction:column;gap:22px">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:16px">
      <div>
        <div style="font-weight:600;font-size:15px">מצב קשה</div>
        <div style="font-size:12px;color:var(--muted);margin-top:3px">יש להשתמש בכל הרמזים שנחשפו בניחושים הבאים</div>
      </div>
      <button id="toggleHard" role="switch" aria-checked="false" class="toggle-btn"></button>
    </div>
    <div style="display:flex;justify-content:space-between;align-items:center;gap:16px">
      <div>
        <div style="font-weight:600;font-size:15px">ניגודיות גבוהה</div>
        <div style="font-size:12px;color:var(--muted);margin-top:3px">קונטרסט והתאמה לעיוורון צבעים</div>
      </div>
      <button id="toggleContrast" role="switch" aria-checked="false" class="toggle-btn"></button>
    </div>
    <div style="display:flex;justify-content:space-between;align-items:center;gap:16px">
      <div>
        <div style="font-weight:600;font-size:15px">מצב לילה</div>
        <div style="font-size:12px;color:var(--muted);margin-top:3px">רקע כהה לשימוש בלילה</div>
      </div>
      <button id="toggleDark" role="switch" aria-checked="false" class="toggle-btn"></button>
    </div>
  </div>
</dialog>

<!-- Stats Dialog -->
<dialog id="dlgStats" style="background:var(--panel);color:var(--fg);border:1px solid var(--ring);border-radius:16px;padding:0;min-width:300px;max-width:92vw;width:400px;margin-top:60px">
  <div style="padding:14px 16px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--ring)">
    <strong style="font-size:16px">סטטיסטיקות</strong>
    <button id="dlgClose" style="border:none;background:transparent;cursor:pointer;color:var(--fg);padding:4px;display:flex;align-items:center">
      <svg width="20" height="20" viewBox="0 0 22 22" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"><line x1="4" y1="4" x2="18" y2="18"/><line x1="18" y1="4" x2="4" y2="18"/></svg>
    </button>
  </div>
  <div style="padding:8px 20px 4px;text-align:center">
    <div style="font-size:14px;font-weight:600;margin-bottom:10px">איך הייתי?</div>
    <div style="display:flex;justify-content:center;gap:20px;margin-bottom:14px">
      <div><span id="stPlayed" style="display:block;font-size:34px;font-weight:700;line-height:1.1">0</span><span style="font-size:12px;color:var(--muted)">משחקים</span></div>
      <div><span id="stWin" style="display:block;font-size:34px;font-weight:700;line-height:1.1">0</span><span style="font-size:12px;color:var(--muted)">נצחונות</span></div>
      <div><span id="stPct" style="display:block;font-size:34px;font-weight:700;line-height:1.1">0</span><span style="font-size:12px;color:var(--muted)">% הצלחה</span></div>
    </div>
  </div>
  <div style="padding:0 20px 18px" id="stHistogram"></div>
</dialog>

<script>
'use strict';
function ready(fn){ if (document.readyState!=='loading') fn(); else document.addEventListener('DOMContentLoaded', fn); }
ready(()=>{
  const E = id => document.getElementById(id);
  const el = {
    tabDaily:E('tabDaily'), tabCustom:E('tabCustom'),
    daily:E('daily'), custom:E('custom'),
    dailyBoard:E('dailyBoard'), dailyKbd:E('dailyKbd'),
    dailyShare:E('dailyShare'), countdown:E('countdown'),
    secretInput:E('secretInput'), makeLink:E('makeLink'), linkOut:E('linkOut'),
    customBoard:E('customBoard'), customKbd:E('customKbd'),
    btnStats:E('btnStats'), btnSettings:E('btnSettings'),
    dlgStats:E('dlgStats'), dlgClose:E('dlgClose'),
    stPlayed:E('stPlayed'), stWin:E('stWin'),
  };
  // ---- Daily persistence (local midnight) ----
  const storageKey = 'wordlon.daily';
  function todayStr(){
    const d = new Date(); // user's local tz
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const da = String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${da}`;
  }
  function loadDaily(){
    try{ return JSON.parse(localStorage.getItem(storageKey) || '{}'); }catch(e){ return {}; }
  }
  function saveDaily(obj){
    try{ localStorage.setItem(storageKey, JSON.stringify(obj)); }catch(e){}
  }
  function showWinMessageAttempt(attempt){
    const msgs = ["שיו","וואו","מדהים","מעולה","מושלם","ניצלת ברגע האחרון"];
    const msg = msgs[(attempt-1)|0] || msgs[msgs.length-1];
    toast(msg);
  }


  // Theme (btnTheme hidden but keep code harmless)

  // Debug banner
  function showDebug(msg){
    let b = document.getElementById('dbg');
    if (!b){
      b = document.createElement('div');
      b.id='dbg';
      b.style.cssText='position:fixed;bottom:6px;left:6px;background:#000c;color:#fff;padding:6px 10px;border:1px solid #333;border-radius:8px;font-size:12px;z-index:9999';
      document.body.appendChild(b);
    }
    b.textContent = msg;
  }

  // Normalize
  const finals = {'ך':'כ','ם':'מ','ן':'נ','ף':'פ','ץ':'צ'};
  const norm = s => s.normalize('NFC').replace(/\s+/g,'').replace(/[״"]/g,'').replace(/[ךםןףץ]/g, ch => finals[ch]).trim();

  // Pull global lists (support both variable names)
  const allowedRaw = (typeof allowedWords !== 'undefined' ? allowedWords :
                      (typeof hebWords !== 'undefined' ? hebWords : ''));
  const answersRaw = (typeof wordlons !== 'undefined' ? wordlons :
                      (typeof listOfWords !== 'undefined' ? listOfWords : []));

  // Build ALLOWED set
  let ALLOWED = new Set();
  if (Array.isArray(allowedRaw)){
    ALLOWED = new Set(allowedRaw.map(norm));
  }else if (typeof allowedRaw === 'string'){
    const parts = allowedRaw.split(/[\s,]+/).filter(Boolean);
    ALLOWED = new Set(parts.map(norm));
  }
  // ANSWERS5
  const ANSWERS5 = (Array.isArray(answersRaw) ? answersRaw : [])
    .map(s => (''+s).trim())
    .filter(s => /^[א-תךםןףץ]{5}$/.test(s));

  // showDebug(...);

  if (ANSWERS5.length === 0){ ANSWERS5.push('שלום'); }
  if (ALLOWED.size === 0){
    ['שלום','חלום','חלון','עולם','בדיקה','אולפן','תמונה'].forEach(w=>ALLOWED.add(norm(w)));
  }

  // Daily answer
  const tz='Asia/Jerusalem';
  function dailyIndex(){
    const localEpoch = new Date(2024, 11, 31); // Dec 31 = day 0, so Jan 1 2025 = day 1 (matches original)
    const today = new Date();
    const localMidnight = new Date(today.getFullYear(), today.getMonth(), today.getDate());
    const days = Math.floor((localMidnight - localEpoch) / 86400000);
    return ANSWERS5.length ? ((days % ANSWERS5.length + ANSWERS5.length) % ANSWERS5.length) : 0;
  }
  function getDailyAnswer(){ return ANSWERS5[dailyIndex()]; }

  // UI + keyboard + game
  const rowsCount = 6;
  const hebRows = [
    ['פ','ו','ט','א','ר','ק'],
    ['ל','ח','י','ע','כ','ג','ד','ש'],
    ['ת','צ','מ','נ','ה','ב','ס','ז']
  ];
  function isHeb(s){ return /^[א-תךםןףץ]+$/.test(s); }

  function buildBoard(container,len=5,rows=rowsCount){
    container.style.setProperty('--len', len);
    container.innerHTML='';
    for (let r=0;r<rows;r++){
      const row=document.createElement('div'); row.className='row';
      for (let c=0;c<len;c++){
        const t=document.createElement('div'); t.className='tile'; t.dataset.row=r; t.dataset.col=c;
        row.appendChild(t);
      }
      container.appendChild(row);
    }
  }
  function buildKeyboard(container,onKey){
    container.innerHTML='';
    hebRows.forEach((row,ri)=>{
      const R=document.createElement('div'); R.className='kbd-row';
      if(ri===0){
        const bk=document.createElement('button'); bk.className='key'; bk.innerHTML='⌫'; bk.onclick=()=>onKey('BACK'); R.appendChild(bk);
        row.forEach(ch=>{ const b=document.createElement('button'); b.className='key'; b.textContent=ch; b.onclick=()=>onKey(ch); R.appendChild(b); });
      } else if(ri===2){
        const enter=document.createElement('button'); enter.className='key'; enter.innerHTML='&#x23CE;'; enter.onclick=()=>onKey('ENTER'); R.appendChild(enter);
        row.forEach(ch=>{ const b=document.createElement('button'); b.className='key'; b.textContent=ch; b.onclick=()=>onKey(ch); R.appendChild(b); });
      } else {
        row.forEach(ch=>{ const b=document.createElement('button'); b.className='key'; b.textContent=ch; b.onclick=()=>onKey(ch); R.appendChild(b); });
      }
      container.appendChild(R);
    });
  }
  const lettersEqual = (a,b)=> (finals[a]||a) === (finals[b]||b);
  function scoreGuess(guess,answer){
    const n=answer.length, res=Array(n).fill('miss'), ans=answer.split(''), g=guess.split('');
    for (let i=0;i<n;i++){ if (lettersEqual(g[i],ans[i])){ res[i]='hit'; ans[i]=null; g[i]=null; } }
    for (let i=0;i<n;i++){ if (g[i]==null) continue; const idx=ans.findIndex(ch=>ch && lettersEqual(ch,g[i])); if (idx>-1){ res[i]='near'; ans[idx]=null; } }
    return res;
  }

  function toast(msg){ const t=E('toast'); t.textContent=msg; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 1200); }

  function Game({boardEl,kbdEl,answer,mode='daily',shareEl,onWinLose}){
    const len=answer.length; let curRow=0, curCol=0, done=false;
    buildBoard(boardEl,len); buildKeyboard(kbdEl, handleKey);
    const tiles=Array.from({length:rowsCount},()=>Array(len).fill('')); let sessionGuesses=[];
const keyStates={};
    const tileAt=(r,c)=>boardEl.children[r].children[c];

    const _toFinal={'כ':'ך','מ':'ם','נ':'ן','פ':'ף','צ':'ץ'};
    function updateTiles(popIndex=null){
      for(let c=0;c<len;c++){
        const t=tileAt(curRow,c); const ch=tiles[curRow][c]||'';
        t.textContent=ch?(c===len-1&&_toFinal[ch]?_toFinal[ch]:ch):'';
        t.classList.toggle('filled',!!ch);
        if(popIndex===c){t.classList.remove('pop');void t.offsetWidth;t.classList.add('pop');}
      }
    }
    const _finals={'ך':'כ','ם':'מ','ן':'נ','ף':'פ','ץ':'צ'};
    const _revFinals={'כ':'ך','מ':'ם','נ':'ן','פ':'ף','צ':'ץ'};
    function paintKeys(){
      for(const [ch,state] of Object.entries(keyStates)){
        const base=_finals[ch]||ch;
        [...kbdEl.querySelectorAll('.key')].filter(b=>b.textContent.trim()===base||b.textContent.trim()===ch).forEach(b=>{
          b.classList.remove('hit','near','miss'); b.classList.add(state);
        });
      }
    }
    function revealRow(marks){
      const rEl = boardEl.children[curRow];
      [...rEl.children].forEach((t,i)=>{
        setTimeout(()=>{
          // Phase 1: fold down (scaleY 1 -> 0)
          t.style.transition='transform 0.25s ease-in';
          t.style.transform='scaleY(0)';
          setTimeout(()=>{
            // Apply color at the halfway point
            t.classList.remove('hit','near','miss');
            t.classList.add(marks[i]);
            // Phase 2: unfold up (scaleY 0 -> 1)
            t.style.transition='transform 0.25s ease-out';
            t.style.transform='scaleY(1)';
          }, 250);
        }, i * 300);
      });
    }
    function commitGuess(){
      const guess = tiles[curRow].join('');
      if (guess.length!==len){ rowShake(); toast('לא מספיק אותיות'); return; }
      if (!isHeb(guess)){ rowShake(); toast('רק עברית'); return; }

      if (mode==='daily'){
        if (!ALLOWED.has(norm(guess))){
          rowShake(); toast('מילה לא מוכרת'); return;
        }
      }

      // Hard mode: enforce using revealed hints
      if (localStorage.getItem('hardMode')==='true' && curRow > 0){
        const curLetters = guess.split('');
        for(let r=0; r<curRow; r++){
          const prev = sessionGuesses[r];
          if(!prev) continue;
          const pm = scoreGuess(prev, answer);
          for(let i=0; i<len; i++){
            if(pm[i]==='hit'){
              if(!lettersEqual(curLetters[i], prev[i])){
                rowShake(); toast('מצב קשה: האות ' + prev[i] + ' חייבת במיקום ' + (i+1)); return;
              }
            }
          }
          for(let i=0; i<len; i++){
            if(pm[i]==='near'){
              if(!curLetters.some(ch => lettersEqual(ch, prev[i]))){
                rowShake(); toast('מצב קשה: חייב להכיל את האות ' + prev[i]); return;
              }
            }
          }
        }
      }
      sessionGuesses.push(guess);
      const marks=scoreGuess(guess,answer);
      revealRow(marks);
      // --- persist daily state ---
      if (mode==='daily'){
        const isWin = (guess === answer);
        const lastRow = (curRow >= (rowsCount-1));
        if (isWin || lastRow){
          try{ saveDaily({...loadDaily(), date:todayStr(), guesses:sessionGuesses.slice(), finished:true}); }catch(e){}
        } else {
          try{ saveDaily({...loadDaily(), date:todayStr(), guesses:sessionGuesses.slice(), finished:false}); }catch(e){}
        }
      }

      guess.split('').forEach((ch,i)=>{
        const m=marks[i]; const rank={miss:0,near:1,hit:2};
        const base=finals[ch]||ch; const fin=({'כ':'ך','מ':'ם','נ':'ן','פ':'ף','צ':'ץ'})[base]||null;
        [base,fin].filter(Boolean).forEach(k=>{ if(!keyStates[k]||rank[m]>rank[keyStates[k]]) keyStates[k]=m; });
      });
      paintKeys();
      const win = marks.every(m=>'hit'===m);
      curRow++; curCol=0;
      if (win){ done=true;
      saveDaily({...loadDaily(), date:todayStr(), played:true, win:true, tries:curRow, guesses:sessionGuesses, answer});
      if(!window._isReplaying) showWinMessageAttempt(curRow);
       onWinLose && onWinLose(true,curRow); return; }
      if (curRow>=rowsCount){ saveDaily({...loadDaily(), date: todayStr(), played: true, win: false, finished: true, tries: rowsCount, guesses: sessionGuesses, answer}); if(!window._isReplaying) toast('המילה הייתה: '+answer); done=true; onWinLose&&onWinLose(false,curRow); return; }
    }
    function rowShake(){ const row=boardEl.children[curRow]; row.classList.remove('shake'); void row.offsetWidth; row.classList.add('shake'); }
    function handleKey(k){
      if (done) return;
      if (k==='ENTER') return commitGuess();
      if (k==='BACK'){ if (curCol>0){ curCol--; tiles[curRow][curCol]=''; updateTiles(); } return; }
      if (k.length===1){
        if (curCol>=len) return;
        if (!/^[א-תךםןףץ]$/.test(k)) return;
        tiles[curRow][curCol]=k; updateTiles(curCol); curCol++;
      }
    }
    window.addEventListener('keydown', ev=>{
      if(document.querySelector('dialog[open]')) return;
      const k=ev.key;
      if (k==='Enter') return handleKey('ENTER');
      if (k==='Backspace') return handleKey('BACK');
      if (/^[א-ת]$/.test(k)) return handleKey(k);
    });
    return {handleKey};
  }

  // Tabs + Stats + Countdown
  const baseURL = location.origin + location.pathname.replace(/index\.html?$/,'');
  const statsKey='wordlon.stats';
  function loadStats(){ try{ return JSON.parse(localStorage.getItem(statsKey))||{dist:{},played:0,wins:0}; }catch(e){ return {dist:{},played:0,wins:0}; } }
  function saveStats(s){ localStorage.setItem(statsKey,JSON.stringify(s)); }
  function recordResult(tries,won){
    const daily=loadDaily();
    if(daily && daily.date===todayStr() && daily.recorded) return;
    saveDaily({...daily, date:todayStr(), recorded:true});
    const s=loadStats();
    if(!s.dist) s.dist={}; if(!s.played) s.played=0; if(!s.wins) s.wins=0;
    s.played++; if(won) s.wins++;
    const key=won?String(tries):'X';
    s.dist[key]=(s.dist[key]||0)+1;
    saveStats(s);
  }
  function updateStatsUI(){
    const s=loadStats(); const dist=s.dist||{};
    const allVals=Object.values(dist).filter(v=>typeof v==='number');
    const max=Math.max(1,...allVals);
    const container=E('stHistogram'); container.innerHTML='';
    const rows=[1,2,3,4,5,6,'X'];
    rows.forEach(i=>{
      const count=dist[String(i)]||0, pct=Math.round((count/max)*100);
      const row=document.createElement('div');
      row.style.cssText='display:flex;align-items:center;gap:8px;margin-bottom:7px;direction:rtl';
      const lbl=document.createElement('span');
      lbl.textContent=i; lbl.style.cssText='width:16px;text-align:center;font-weight:600;flex-shrink:0';
      if(i==='X') lbl.style.color='#e55';
      const bar=document.createElement('div');
      bar.style.cssText=`height:26px;background:${count>0&&i!=='X'?'var(--hit)':'var(--miss)'};border-radius:4px;display:flex;align-items:center;padding:0 8px;min-width:26px;width:${Math.max(pct,4)}%;transition:width .4s`;
      const num=document.createElement('span'); num.textContent=count; num.style.cssText='color:#fff;font-weight:700;font-size:13px';
      bar.appendChild(num); row.appendChild(lbl); row.appendChild(bar); container.appendChild(row);
    });
    if(!allVals.length) container.innerHTML='<p style="text-align:center;color:var(--muted)">עדיין אין נתונים</p>';
    const played = Object.values(dist).reduce((a,b)=>a+(+b||0),0);
    const wins   = Object.entries(dist).filter(([k])=>k!=='X').reduce((a,[,v])=>a+(+v||0),0);
    const pct=played>0?Math.round((wins/played)*100):0;
    if(el.stPlayed) el.stPlayed.textContent=played;
    if(el.stWin) el.stWin.textContent=wins;
    const pctEl=E('stPct'); if(pctEl) pctEl.textContent=pct;
  }
  el.btnStats.addEventListener('click', ()=>{ updateStatsUI(); el.dlgStats.showModal(); el.btnStats.blur(); });
  el.dlgClose.addEventListener('click', ()=>{ el.dlgStats.close(); setTimeout(()=>document.activeElement?.blur(), 50); });

  // Settings
  const dlgSettings = E('dlgSettings');
  el.btnSettings.addEventListener('click', ()=>{ dlgSettings.showModal(); el.btnSettings.blur(); });
  dlgSettings.addEventListener('close', ()=>setTimeout(()=>document.activeElement?.blur(), 50));
  el.dlgStats.addEventListener('close', ()=>setTimeout(()=>document.activeElement?.blur(), 50));
  E('dlgSettingsClose').addEventListener('click', ()=>{ dlgSettings.close(); setTimeout(()=>document.activeElement?.blur(), 50); });

  let hardMode = localStorage.getItem('hardMode')==='true';
  const toggleHard = E('toggleHard');
  function applyHardMode(v){ hardMode=v; window.hardMode=v; toggleHard.setAttribute('aria-checked',v?'true':'false'); localStorage.setItem('hardMode',v); }
  applyHardMode(hardMode); window.hardMode=hardMode;
  toggleHard.addEventListener('click',()=>applyHardMode(!hardMode));

  let highContrast = localStorage.getItem('highContrast')==='true';
  const toggleContrast = E('toggleContrast');
  function applyContrast(v){ highContrast=v; toggleContrast.setAttribute('aria-checked',v?'true':'false'); document.documentElement.setAttribute('data-contrast',v?'true':'false'); localStorage.setItem('highContrast',v); }
  applyContrast(highContrast);
  toggleContrast.addEventListener('click',()=>applyContrast(!highContrast));

  let darkMode = localStorage.getItem('darkMode')!=='false';
  const toggleDark = E('toggleDark');
  function applyDark(v){ darkMode=v; toggleDark.setAttribute('aria-checked',v?'true':'false'); document.documentElement.setAttribute('data-theme',v?'':'light'); localStorage.setItem('darkMode',v); }
  applyDark(darkMode);
  toggleDark.addEventListener('click',()=>applyDark(!darkMode));

  function selectTab(id){
    [el.tabDaily, el.tabCustom].forEach(t=>{ const on=t.dataset.target===id; t.setAttribute('aria-selected', on?'true':'false'); });
    [el.daily, el.custom].forEach(s=>{ s.setAttribute('aria-hidden', s.id===id ? 'false':'true'); });
  }
  el.tabDaily.addEventListener('click', ()=>selectTab('daily'));
  el.tabCustom.addEventListener('click', ()=>selectTab('custom'));

  function maybeLoadCustomFromLink(){
    const m2=location.hash.match(/#custom=([^&]+)/);
    if (m2){ const secret=decodeURIComponent(m2[1]); if (/^[א-תךםןףץ]{5}$/.test(secret)){ selectTab('custom'); return startCustomGame(secret); } }
  }
  function startCustomGame(secret){
    if (!/^[א-תךםןףץ]{5}$/.test(secret)){ toast('רק מילים בנות 5 אותיות'); return; }
    el.customBoard.innerHTML=''; el.customKbd.innerHTML=''; el.linkOut.innerHTML='';
    Game({boardEl: el.customBoard, kbdEl: el.customKbd, answer:secret, mode:'custom', shareEl:el.linkOut});
  }
  window.addEventListener('hashchange', maybeLoadCustomFromLink);

  document.getElementById('year').textContent = new Date().getFullYear();

  // Loss banner
  function showLossBanner(word){
    const b=E('lossBanner'); b.textContent='המילה הייתה: '+word; b.style.display='block';
  }

  // Boot
  const dailyAnswer = getDailyAnswer();
  const _stBoot = loadDaily();
  const _alreadyToday = _stBoot && _stBoot.date===todayStr() && _stBoot.recorded;
  if (_stBoot && _stBoot.date===todayStr() && _stBoot.win===false && _stBoot.finished && _stBoot.answer){
    showLossBanner(_stBoot.answer);
  }

  const dailyGame = Game({boardEl: el.dailyBoard, kbdEl: el.dailyKbd, answer:dailyAnswer, mode:'daily', shareEl:el.dailyShare,
    onWinLose:(won,tries)=>{
      if(!window._isReplaying){
        if(!_alreadyToday) recordResult(tries,won);
        if(!won) showLossBanner(dailyAnswer);
        const animMs = (dailyAnswer.length - 1) * 300 + 500;
        setTimeout(()=>{ updateStatsUI(); el.dlgStats.showModal(); }, animMs + 800);
      }
    }
  });

  (function replayIfPlayed(){
    const st = loadDaily();
    if(st && st.date===todayStr() && Array.isArray(st.guesses) && st.guesses.length){
      // Only mark recorded if game was finished - prevents blocking first-time stats
      if(st.finished || st.win) saveDaily({...st, recorded:true});
      window._isReplaying=true;
      function typeWord(word){
        for(const ch of word) window.dispatchEvent(new KeyboardEvent('keydown',{key:ch}));
        window.dispatchEvent(new KeyboardEvent('keydown',{key:'Enter'}));
      }
      st.guesses.slice(0,rowsCount).forEach(typeWord);
      window._isReplaying=false;
    }
  })();
function updateCountdown(){
    const now=new Date();
    const midnight=new Date(); midnight.setHours(24,0,0,0);
    const diff=midnight-now;
    if (diff <= 1000) { setTimeout(()=>location.reload(), 1000); }
    const h=String(Math.floor(diff/3_600_000)).padStart(2,'0');
    const m=String(Math.floor((diff%3_600_000)/60_000)).padStart(2,'0');
    const s=String(Math.floor((diff%60_000)/1000)).padStart(2,'0');
    el.countdown.textContent=`${h}:${m}:${s}`;
  }
  setInterval(updateCountdown, 1000);
  updateCountdown();
  maybeLoadCustomFromLink();
});
</script>




<script>
var _lastTap=0;
document.addEventListener('touchend',function(e){
  if(e.target.closest('.key')){
    var now=Date.now();
    if(now-_lastTap<300) e.preventDefault();
    _lastTap=now;
  }
},{passive:false});
</script>
</body>
</html>
